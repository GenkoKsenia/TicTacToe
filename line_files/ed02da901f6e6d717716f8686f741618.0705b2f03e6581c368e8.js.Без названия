(self.webpackChunkvk=self.webpackChunkvk||[]).push([[87586],{272146:(e,t,o)=>{"use strict";o.d(t,{photos:()=>P});var s=o(873589),i=o(840060),r=o(733164),a=o(631351),n=o(101178),l=o(549357),d=o(501389),h=o(152278),c=o(342269),u=o(927766),p=o(897449),g=o(146143),_=o(990523),m=o(66433),f=o(226323),v=o(608021),w=o(169424),C=o(569334),E=o(533321),b=o(555030),T=o(997109),P={LOAD_TYPE_PHOTOS:"photos",LOAD_TYPE_ALBUMS:"albums",LOAD_TYPE_TAGGED:"tagged",MAX_DESC_INPUT_HEIGHT:600,changeAlbumPhoto(e){(0,g.showBox)("al_photos.php",{act:"change_thumb_box",album:e})},onMouseOverEditRow(e){var t=(0,s.geByClass1)("photos_photo_edit_row_desc_placeholder",e),o=(0,s.geByClass1)("photos_photo_edit_row_desc_input",e);(0,s.setTitle)(t,!1,(0,s.val)(o))},editInitSorter(){var e=(0,s.ge)("photos_container_photos");cur.photosEditSorter=new GridSorter(e,"photos_photo_edit_row_thumb",{onReorder:P.reorderPhotos})},updateEditHeaderPos(){void 0===cur.photosEditHeaderEl&&(cur.photosEditHeaderEl=(0,s.geByClass1)("photos_edit_selection_header")),cur.photosEditHeaderEl&&(cur.photosEditHeaderElOffset=cur.photosEditHeaderElOffset||(0,s.getXY)(cur.photosEditHeaderEl)[1]-(0,s.getSize)((0,s.ge)("page_header_cont"))[1],(0,u.scrollGetY)()>=cur.photosEditHeaderElOffset?(0,s.hasClass)(cur.photosEditHeaderEl,"photos_header_fixed")||((0,s.addClass)(cur.photosEditHeaderEl,"photos_header_fixed"),(0,s.setStyle)(cur.photosEditHeaderEl,{width:(0,s.getSize)((0,s.ge)("page_body"))[0]}),(0,s.setStyle)((0,s.domNS)(cur.photosEditHeaderEl),{"margin-top":(0,s.getSize)(cur.photosEditHeaderEl)[1]+"px"})):((0,s.removeClass)(cur.photosEditHeaderEl,"photos_header_fixed"),(0,s.setStyle)(cur.photosEditHeaderEl,{width:""}),(0,s.setStyle)((0,s.domNS)(cur.photosEditHeaderEl),{"margin-top":0})))},_editGetSelectedCount(){var e=(0,s.geByClass)("photos_edit_selected").length;if(cur.photoEditSelectedAll){var t=(0,s.geByClass)("photos_photo_edit_row").length;e=e<t?cur.count-t+e:cur.count}return e},editSelectAll(e){cur.photoEditSelectedAll=!e,(0,c.each)((0,s.geByClass)("photos_photo_edit_row"),(function(){(0,s.toggleClass)(this,"photos_edit_selected",cur.photoEditSelectedAll)})),P._editUpdateSelectedCounter()},_editUpdateSelectedCounter(){var e,t=P._editGetSelectedCount();e=t?v.getLang("photos_edit_selected_count").replace("{total}",cur.count).replace("{count}",t):(0,v.langNumeric)(cur.count,v.curLang("photos_edit_selected_count_initial"),!0),(0,s.val)((0,s.ge)("photos_edit_selected_label"),e);var o=(0,s.ge)("photos_edit_selected_actions");(0,s.toggleClass)(o,"photos_selected",!!t),(0,s.geByClass)("photos_edit_selected_action",o).forEach((function(e){(0,s.toggleClass)(e,"link_lock",!t)}));var i=(0,s.ge)("photos_select_all_toggle");cur.photosEditSelectedHalf=t>=cur.count/2,cur.photosEditSelectedHalf?(0,s.val)(i,v.getLang("photos_edit_deselect_all")):(0,s.val)(i,v.getLang("photos_edit_select_all"))},selectEditPhoto(e,t){var o=(0,s.gpeByClass)("photos_photo_edit_row",t),i=(0,s.toggleClass)(o,"photos_edit_selected");if(e.shiftKey&&cur.photoEditPrevSelectedRowEl&&cur.photoEditPrevSelectedRowEl!=o)for(var r=(0,s.gpeByClass)("photos_edit_photos_container",t),a=(0,s.domFC)(r),n=0;n<2&&a;)a!=cur.photoEditPrevSelectedRowEl&&a!=o||n++,n&&(0,s.toggleClass)(a,"photos_edit_selected",i),a=(0,s.domNS)(a);return cur.photoEditPrevSelectedRowEl=o,P._editUpdateSelectedCounter(),(0,h.cancelEvent)(e),!1},startEditPhotoDescription(e,t){P.stopEditPhotoDescription();var o=(0,s.gpeByClass)("photos_edit_photos_container",t),r=(0,s.hasClass)(t,"photos_photo_edit_row")?t:(0,s.gpeByClass)("photos_photo_edit_row",t),a=(0,s.geByClass1)("photos_photo_edit_row_desc_cont",r),n=(0,s.geByClass1)("photos_photo_edit_row_desc_placeholder",r),l=(0,s.geByClass1)("photos_photo_edit_row_desc_input",r);function d(e,t,o,r){var a=(0,c.clean)((0,s.val)(o)).split("\n").join("<br>")+"&nbsp;",n=(0,s.ce)("div",{innerHTML:a,className:"photos_photo_edit_row_desc_input"},{width:(0,s.getSize)(t)[0],display:"block",visibility:"hidden"});e.appendChild(n);var l=(0,s.getSize)(n)[1]+(i.browser.msie?10:0);(0,s.setStyle)(o,{height:Math.min(P.MAX_DESC_INPUT_HEIGHT,Math.round(l))}),(0,s.re)(n)}(0,s.val)(l,l.getAttribute("data-orig-desc")),d(a,n,l),(0,s.show)(l),(0,h.addEvent)(document,"click",P.stopEditPhotoDescription),(0,h.removeEvent)(l,"input"),(0,h.addEvent)(l,"input",d.pbind(a,n,l)),l.select(),(0,s.addClass)(o,"photos_desc_editing"),(0,s.addClass)(r,"photos_row_desc_editing"),e&&(0,h.cancelEvent)(e)},onEditPhotoDescriptionKeyPress(e){switch(e.keyCode){case 27:P.stopEditPhotoDescription(null,!0);break;case 9:P.stopEditPhotoDescription(null,!1);var t=(0,s.gpeByClass)("photos_photo_edit_row",e.currentTarget);(t=(0,s.domNS)(t))&&P.startEditPhotoDescription(null,t),(0,h.cancelEvent)(e)}},stopEditPhotoDescription(e,t){var o;e&&(0,s.hasClass)(e.target,"photos_photo_edit_row_desc_input")||((0,h.removeEvent)(document,"click",P.stopEditPhotoDescription),(0,c.each)((0,s.geByClass)("photos_row_desc_editing"),(function(){o=this,(0,s.removeClass)(o,"photos_row_desc_editing");var e=(0,s.geByClass1)("photos_photo_edit_row_desc_placeholder",o),i=(0,s.geByClass1)("photos_photo_edit_row_desc_input",o),r=o.getAttribute("data-id"),a=o.getAttribute("data-edit-hash"),n="";t?n=i.getAttribute("data-orig-desc"):((n=(0,c.trim)((0,s.val)(i)))!=i.getAttribute("data-orig-desc")&&ajax.post("al_photos.php",{act:"save_desc",photo:r,hash:a,text:n,edit:1},{}),i.setAttribute("data-orig-desc",n),e.titleSet=!1);(0,s.val)(e,(0,c.clean)(n)||v.getLang("photos_add_description_placeholder")),(0,s.toggleClass)(e,"photos_edit_has_desc",!!n),(0,s.hide)(i)})),(0,s.removeClass)((0,s.gpeByClass)("photos_edit_photos_container",o),"photos_desc_editing"))},updatePeriods(){cur.periods=(0,s.geByClass)("photos_period_delimiter",(0,s.ge)("photos_all_block"))},destroyPeriod(){cur.fixedPeriod&&((0,s.re)(cur.fixedPeriod),cur.fixedPeriod=!1,cur.fixedPeriodEl=!1)},fixPeriod(){if((0,s.ge)("photos_albums_block")&&(P.headerHeight=P.headerHeight||(0,s.getSize)((0,s.ge)("page_header_cont"))[1],cur.periods&&cur.periods.length)){var e=vk.staticheader?Math.max((0,u.scrollGetY)(),P.headerHeight):(0,u.scrollGetY)()+P.headerHeight,t=!1,o=!1,i=(0,s.getSize)(cur.periods[0])[1];for(var r in cur.periods)if(cur.periods.hasOwnProperty(r)){if((0,s.getXY)(cur.periods[r])[1]>=e)break;t=cur.periods[r];var a=(0,c.intval)(r)+1;o=!!cur.periods[a]&&(0,s.getXY)(cur.periods[a])[1]-e}if(t&&!cur.fileApiUploadStarted){if(t==cur.fixedPeriodEl)setTimeout((function(){(0,s.setStyle)(cur.fixedPeriod,{left:(0,s.getXY)(t)[0]+"px"})}));else{if(cur.fixedPeriod)cur.fixedPeriod.innerHTML=t.innerHTML;else{var n=cur.fixedPeriod=(0,s.ce)("div",{innerHTML:t.innerHTML,className:"photos_period_delimiter_fixed"},{left:(0,s.getXY)(t)[0]+"px"});(0,s.ge)("page_body").appendChild(cur.fixedPeriod),(cur._back?cur._back.hide:cur.destroy).push((function(){(0,s.re)(n)}))}cur.fixedPeriodEl=t}var l=!1!==o?o-i:0;l>=0&&(l=0),cur.fixedPeriodTop!==l&&((0,s.setStyle)(cur.fixedPeriod,{top:l+"px"}),cur.fixedPeriodTop=l)}else!t&&cur.fixedPeriod&&((0,s.re)(cur.fixedPeriod),cur.fixedPeriod=!1,cur.fixedPeriodEl=!1)}},scrollResize(){if(!i.browser.mobile&&!cur.pvShown){var e=document.documentElement,t=window.innerHeight||e.clientHeight||document.body.clientHeight,o=(0,u.scrollGetY)(),r=(0,s.ge)("ui_photos_load_more"),a=(0,s.ge)("ui_albums_load_more"),n=(0,s.ge)("ui_tagged_load_more"),l=.8*t;(0,s.isVisible)(r)&&r.offsetTop-(o+t)<l&&P.load(),(0,s.isVisible)(a)&&cur.showAllAlbums&&a.offsetTop-(o+t)<l&&P.load(P.LOAD_TYPE_ALBUMS),(0,s.isVisible)(n)&&cur.showAllTagged&&n.offsetTop-(o+t)<l&&P.load(P.LOAD_TYPE_TAGGED),cur.fixPeriods&&P.fixPeriod(),P.updateEditHeaderPos()}},initScroll(){cur.module="photos",P.scrollnode=window,(0,h.addEvent)(P.scrollnode,"scroll",P.scrollResize),(0,h.addEvent)(window,"resize",P.scrollResize),(0,h.removeEvent)(window,"load",P.initScroll),cur.destroy.push((function(){(0,h.removeEvent)(P.scrollnode,"scroll",P.scrollResize),(0,h.removeEvent)(window,"resize",P.scrollResize)}))},recache(e,t){if(cur.loading)return cur.loading=1,void setTimeout(P.recache.pbind(e,t),100);for(var o=cur.offset;ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+o+"&part=1"];o+=20){var s=ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+o+"&part=1"];s[0]+=t,ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+(o+t)+"&part=1"]=s,delete ajaxCache["/"+nav.objLoc[0]+"#act="+nav.objLoc.act+"&offset="+o+"&part=1"]}cur.offset+=t},loaded(e,t,o,i){var r,a,n,l,d,h;switch(i||(cur.loading=0),i=i||P.LOAD_TYPE_PHOTOS){case P.LOAD_TYPE_TAGGED:cur.taggedOffset=e,n=cur.moreFromTagged,d=cur.moreTaggedOpts,l=cur.taggedOffset;break;case P.LOAD_TYPE_ALBUMS:cur.albumsOffset=e,n=cur.moreFromAlbums,d=cur.moreAlbumsOpts,l=cur.albumsOffset,h=cur.albumsCount;break;default:cur.offset=e,n=cur.moreFrom,d=cur.moreOpts,l=cur.offset,h=cur.count}r=(0,s.ge)("photos_container_"+i),a=(0,s.ge)("ui_"+i+"_load_more");for(var u=(0,s.ce)("div",{innerHTML:(0,c.trim)(t)});u.firstChild;){if((0,s.hasClass)(u.firstChild,"photos_period_delimiter")){var p=u.firstChild.getAttribute("data-year");if((0,s.geByClass1)("photos_period_delimiter_"+p)){(0,s.re)(u.firstChild);continue}}cur.photoEditSelectedAll&&(0,s.addClass)(u.firstChild,"photos_edit_selected"),r.appendChild(u.firstChild)}o&&(0,c.extend)(cur.privacy,o),i==P.LOAD_TYPE_PHOTOS&&P.updatePeriods(),e>=h||!t?(0,s.hide)(a):i!=P.LOAD_TYPE_PHOTOS&&(cur.loading=1,ajax.post(n,(0,c.extend)({offset:l,part:1},d||{}),{cache:1,onDone:function(){2==cur.loading?P.loaded.apply(window,arguments):cur.loading=!1},onFail:function(){return cur.loading=0,!0}}))},load(e){var t,o,i,r;switch(e=e||P.LOAD_TYPE_PHOTOS){case P.LOAD_TYPE_PHOTOS:t=(0,s.ge)("ui_photos_load_more"),o=cur.moreFrom,i=cur.moreOpts,r=cur.offset;break;case P.LOAD_TYPE_TAGGED:t=(0,s.ge)("ui_tagged_load_more"),o=cur.moreFromTagged,i=cur.moreTaggedOpts,r=cur.taggedOffset;break;case P.LOAD_TYPE_ALBUMS:t=(0,s.ge)("ui_albums_load_more"),o=cur.moreFromAlbums,i=cur.moreAlbumsOpts,r=cur.albumsOffset}o&&(0,s.isVisible)(t)&&!(0,p.isButtonLocked)(t)&&(cur.loading?cur.loading=2:(e==P.LOAD_TYPE_PHOTOS&&i&&(cur.loading=1),ajax.post(o,(0,c.extend)({offset:r,part:1},i||{}),{onDone:P.loaded,onFail:function(){return cur.loading=0,!0},showProgress:function(){(0,p.lockButton)(t)},hideProgress:function(){(0,p.unlockButton)(t)},cache:1})))},loadMoreButtonClick(e){switch(e){case P.LOAD_TYPE_ALBUMS:cur.showAllAlbums=!0;break;case P.LOAD_TYPE_TAGGED:cur.showAllTagged=!0}this.load(e)},reorderAlbums(e,t,o){var s=e.id.replace("album",""),i=(t&&t.id||"").replace("album",""),r=(o&&o.id||"").replace("album","");ajax.post("al_photos.php",{act:"reorder_albums",album:s,before:i,after:r,hash:cur.reorderHash})},reorderPhotos(e,t,o){var i="edit"==nav.objLoc.act?"photo_edit_row_":"photo_row_",r=e.id.replace(i,""),a=(t&&t.id||"").replace(i,""),n=(o&&o.id||"").replace(i,""),l=(0,s.domData)((0,s.ge)("photos_container_photos"),"rev");l=l?"1"===l?1:"":nav.objLoc.rev,ajax.post("al_photos.php",{act:"reorder_photos",photo:r,before:a,after:n,rev:l,hash:cur.reorderHash})},privacy(e){if("photos_move"==e){var t=Privacy.getValue(e);return(t=(t=t.split("_"))[2])!=cur.album.split("_")[1]&&P.movePhoto(t),!0}var o=e.match(/^album(\d+)/);if(o){var i=(0,s.ge)("album"+vk.id+"_"+o[1]);if(i){if(i.helper){var r=(0,s.getSize)(i);if(r[0]!=i.w||r[1]!=i.h){(0,s.setStyle)(i.helper,{width:r[0],height:r[1]-(0,s.ge)("photos_container").sorter.dh}),(0,c.extend)(i,{x:i.x-i.w/2+r[0]/2,w:r[0],y:i.y-i.h/2+r[1]/2,h:r[1]});for(var a=i.nextSibling;a&&a.nextSibling;a=a.nextSibling.nextSibling)(0,s.setStyle)(a.nextSibling,{left:a.offsetLeft,top:a.offsetTop})}}clearTimeout(cur["privacy_timer_"+e]),cur["privacy_timer_"+e]=setTimeout(ajax.post.pbind("al_friends.php",{act:"save_privacy",key:e,val:Privacy.getValue(e),hash:cur.privacyHash}),500)}}},deleteAlbum(e,t){(0,g.showFastBox)({title:v.getLang("photos_deleting_album"),bodyStyle:"padding: 20px;"},v.getLang("photos_sure_del_album"),v.getLang("global_delete"),(function(o){ajax.post("al_photos.php",{act:"delete_album",album:e,hash:t},{showProgress:()=>(0,p.lockButton)(o),hideProgress:()=>(0,p.unlockButton)(o)})}),v.getLang("global_cancel"))},showSaved(e,t){var o=(0,s.ge)(e),i=function(){setTimeout(a.animate.pbind(o,{backgroundColor:t,borderLeftColor:"#D8DFEA",borderRightColor:"#D8DFEA",borderTopColor:"#D8DFEA",borderBottomColor:"#D8DFEA"},1e3),1e3)};(0,s.isVisible)(o)?(0,a.animate)(o,{backgroundColor:"#E7F1F9",borderLeftColor:"#4C96D4",borderRightColor:"#4C96D4",borderTopColor:"#4C96D4",borderBottomColor:"#4C96D4"},200,i):((0,s.show)(o),i())},saveAlbum(e){var t={act:"save_album",album:cur.album,hash:cur.albumhash,title:(0,s.ge)("album_title").value,desc:(0,s.ge)("album_description").value,enable_hintach:(0,p.isChecked)("hintach_enabled_for_album")};if(!t.title)return(0,p.notaBene)("album_title");var o=cur.album.replace(vk.id+"_","");cur.privacy["album"+o]?(0,c.extend)(t,{view:Privacy.getValue("album"+o),comm:Privacy.getValue("albumcomm"+o)}):(0,s.ge)("album_only_check")&&(0,c.extend)(t,{main:(0,p.isChecked)("album_main_check"),only:(0,p.isChecked)("album_only_check"),comm:(0,p.isChecked)("album_comments_check")}),ajax.post("al_photos.php",t,{onDone:function(){var e=(0,s.ge)("album_main_check");e&&(0,p.isChecked)(e)&&((0,s.addClass)(e,"on"),(0,s.addClass)(e,"disabled"),(0,s.hide)("album_delete_action"));var t=(0,s.ge)("photos_changes_saved");(0,s.setStyle)(t,{opacity:1}),setTimeout((function(){(0,s.setStyle)(t,{opacity:0})}),1500)},showProgress:()=>(0,p.lockButton)(e),hideProgress:()=>(0,p.unlockButton)(e)})},savePhotos(){for(var e={act:"save_photos",album:cur.album,hash:cur.albumhash},t=(0,s.ge)("photos_container"),o=0,i=t.firstChild;i;i=i.nextSibling)if(i.firstChild&&(0,s.isVisible)(i.firstChild)){var r=i.id.replace("photo_edit_row","");e["photo_id"+o]=r,e["photo_desc"+o]=(0,s.ge)("photo_caption"+r).value,++o}ajax.post("al_photos.php",e,{onDone:function(){for(var e=t.firstChild;e;e=e.nextSibling)if(e.firstChild&&(0,s.isVisible)(e.firstChild)){var o=e.id.replace("photo_edit_row","");(0,s.ge)("photo_save_result"+o).innerHTML=v.getLang("photos_privacy_description")}cur.descs=!1,(0,u.scrollToTop)(200),P.showSaved("photos_saved_msg","#F3F8FC"),(0,s.ge)("photos_container").sorter&&sorter.update((0,s.ge)("photos_container").sorter.elems[0])},progress:"photos_save_progress"})},deleteSelectedPhotos(e){var t=[];(0,c.each)((0,s.geByClass)("photos_edit_selected"),(function(){t.push(this.getAttribute("data-id"))}));var o=(0,c.intval)(P._editGetSelectedCount()>t.length),i=cur.album.split("_");(0,g.showBox)("/al_photos.php",{act:"delete_selected_box",Photo_ids:o?"":t.join(","),owner_id:i[0],album_id:i[1],all:o},{onDone(){var t=(0,d.curBox)();t.removeButtons(),t.addButton(v.getLang("photos_del_selected_box_yes"),(t=>{(0,s.show)("photos_del_box_progress"),(0,s.hide)("photos_del_box_text"),(0,s.re)(t);var o=(0,s.ge)("photos_del_box_progress_text");P.doEditBatchProcess({act:"delete_photos",hash:e,owner_id:i[0],album_id:i[1]},cur.editDeletePhotosArray,(0,s.ge)("photos_del_box_progress_wrap"),v.getLang("photos_del_selected_title_progress"),(function(e,t,i,r,a){(0,s.val)(o,v.getLang("photos_del_selected_box_text_progress").replace("{count}",r).replace("{total}",a)),cur.count=Math.max(cur.count-e,0),(0,c.each)(i,(function(e,t){(0,s.re)("photo_edit_row_"+t),cur.count=Math.max(cur.count,0)})),P._editUpdateSelectedCounter()}),(function(){var e=(0,d.curBox)();(e&&e.hide(),0==cur.count)?nav.reload():(0,s.geByClass)("photos_photo_edit_row").length<40&&P.load()}))})),t.addButton(v.getLang("box_cancel"),(function(){t.hide(),cur.editDeletePhotosArray=!1}),"no")}})},doEditBatchProcess(e,t,o,i,r,a){var n=t.split(","),l=n.length,h=cur.editPhotosMaxChunkSize||50,u=Math.ceil(l/h),p=(0,s.geByClass1)("photos_progress_bar",(0,s.ge)(o))||(0,s.geByClass1)("ui_progress_bar",(0,s.ge)(o)),g=0,_=document.title,m=(0,d.curBox)();r(0,!1,[],0,l),function t(o){if(!m.isVisible())return a(g),void(0,s.setDocumentTitle)(_);var d=n.slice(o*h,(o+1)*h);ajax.post("/al_photos.php",(0,c.extend)({photos:d.join(",")},e),{onDone:function(e,n,h){g+=e,o++,(0,s.setStyle)(p,{width:100*o/u+"%"}),(0,s.setDocumentTitle)(i.replace("{count}",g).replace("{total}",l)),r(e,n,d,g,l,h),o<u?t(o):setTimeout((function(){(0,s.setDocumentTitle)(_),a(g,n)}),200)}})}(0)},_showProgressPanel(e){var t=(0,s.se)('<div class="photo_mask_progress _photo_mask_progress"><div class="photos_editing_background"></div><div class="round_spinner"></div></div>');return e.appendChild(t),t},_hideProgressPanel(e){(0,s.re)((0,s.geByClass1)("_photo_mask_progress",e))},deletePhoto(e,t,o,i){var r;if(""===e&&o&&(r=(0,s.gpeByClass)("photos_photo_edit_row",o),e=(0,s.attr)(r,"data-id"),t=(0,s.attr)(r,"data-edit-hash")),r=r||(0,s.ge)("photo_edit_row_"+e)){var a=P._showProgressPanel(r);return(0,s.addClass)(r,"photos_deleted"),ajax.post("al_photos.php",{act:"delete_photo",photo:e,hash:t,edit:1},{onDone:function(e){(0,s.re)(a),r.appendChild((0,s.se)(e)),P.recache(cur.offset,-1),cur.count-=1,P._editUpdateSelectedCounter(),cur.count<2&&(0,s.hide)("album_thumb_action"),(0,s.ge)("photos_go_to_album_cont")&&!cur.count&&(0,s.hide)("photos_go_to_album_cont"),cur.photoAddUpdate&&cur.photoAddUpdate(r),cur.introTooltipHide&&cur.introTooltipHide(!0)}}),(0,h.cancelEvent)(i)}},restorePhoto(e,t,o){var i=(0,s.ge)("photo_edit_row_"+t);if(i&&(0,s.hasClass)(i,"photos_deleted")){var r=P._showProgressPanel(i);(0,s.re)((0,s.geByClass1)("photos_restore",i)),ajax.post("al_photos.php",{act:"restore_photo",photo:t,hash:o,edit:1},{onDone:function(){(0,s.re)(r),(0,s.removeClass)(i,"photos_deleted"),P.recache(cur.offset,1),cur.count+=1,P._editUpdateSelectedCounter(),cur.count>1&&(0,s.show)("album_thumb_action"),(0,s.ge)("photos_go_to_album_cont")&&cur.count&&(0,s.show)("photos_go_to_album_cont"),cur.photoAddUpdate&&cur.photoAddUpdate(i)},progress:"photo_restore_progress"+t})}},toggleMoveToAlbumMode(e,t){var o=(0,s.ge)("photos_move_box_search"),i=(0,s.ge)("pv_move_to_album_cont"),r=(0,s.ge)("photos_box_edit_data"),a=(0,d.curBox)(),n=(0,s.geByClass1)("box_title",a.titleWrap);if(e){(0,s.hide)(o),(0,s.hide)(i),(0,s.show)(r),a.setOptions({width:500});var l=v.getLang("photos_move_to_new_album_title");cur.noAlbums||(l+=`\n          <span class="divider">|</span>\n          <a onclick="return photos.toggleMoveToAlbumMode(false, event)" href="" class="toggle">\n            ${v.getLang("photos_move_to_another_album_toggle")}\n          </a>\n        `),(0,s.val)(n,l),a.removeButtons().addButton(v.getLang("photos_create_album_and_move"),cur.saveNewAlbum).addButton(v.getLang("global_cancel"),a.hide,"no"),cur.onNewAlbumDone=function(e){(0,d.curBox)().hide(),P.movePhotosBox(cur.editPhotosArray.split(","),!1,(function(){setTimeout((function(){var t=(0,s.ge)("album"+e);P.doMovePhotos(!1,t)}))}))}}else(0,s.show)(o),(0,s.show)(i),(0,s.hide)(r),a.setOptions({width:795}),(0,s.val)(n,v.getLang("photos_move_box_title")+'<span class="divider">|</span><a onclick="return photos.toggleMoveToAlbumMode(true, event)" href="" class="toggle">'+v.getLang("photos_move_to_new_album")+"</a>"),a.removeButtons().addButton(v.getLang("global_cancel"),a.hide);return(0,h.cancelEvent)(t)},showMove(e,t,o){var i=cur.moveddc,r=(0,s.ge)("photos_move_link"+e);cur.privacyPhotoMove?Privacy.show(r,o,"photos_move"):(cur.zIndexUpdated&&(P.hideMove(),cur.noZIndexUpdate=!0),(0,s.ge)("photo_edit_row"+e)&&(cur.zIndexUpdated=e,(0,s.setStyle)((0,s.ge)("photo_edit_row"+e),{zIndex:150})),P.hideMove()),(0,c.extend)(cur,{movelnk:r,moveph:e,movehash:t}),cur.privacyPhotoMove||(r.parentNode.replaceChild(i,r),cur.movedd.focus(),cur.movedd.showDefaultList(),(0,h.addEvent)(document,"click",P.hideMove))},hideMove(){if(cur.noZIndexUpdate)delete cur.noZIndexUpdate;else if(!cur.privacyPhotoMove){if(cur.movelnk)try{cur.moveddc.parentNode.replaceChild(cur.movelnk,cur.moveddc),cur.movelnk=!1,cur.movedd.clear(),cur.zIndexUpdated&&(0,s.ge)("photo_edit_row"+cur.zIndexUpdated)&&((0,s.setStyle)((0,s.ge)("photo_edit_row"+cur.zIndexUpdated),{zIndex:100}),delete cur.zIndexUpdated)}catch(e){}(0,h.removeEvent)(document,"click",P.hideMove)}},movePhoto(e,t,o){e=(0,c.intval)(e);var i=s.show.pbind("photo_return_progress"+t),r=s.hide.pbind("photo_return_progress"+t);if(!t){if(!e||e==cur.album.split("_")[1])return P.hideMove();t=cur.moveph,o=cur.movehash,i=function(){(0,s.hide)("photo_delete_link"+t),(0,s.show)("photo_edit_progress"+t)},r=function(){(0,s.hide)("photo_edit_progress"+t),(0,s.show)("photo_delete_link"+t)}}ajax.post("al_photos.php",{act:"move_photo",album:e,photo:t,hash:o},{onDone:function(o){var i=(0,s.ge)("photo_edit_row"+t);if(i&&i.firstChild){if(e==cur.album.split("_")[1]){if((0,s.isVisible)(i.firstChild))return;i.removeChild(i.firstChild.nextSibling),(0,s.show)(i.firstChild),P.recache(cur.offset,1),++cur.count,cur.count>1&&(0,s.show)("album_thumb_action")}else{if(!(0,s.isVisible)(i.firstChild))return;P.hideMove(),(0,s.hide)(i.firstChild),i.appendChild((0,s.ce)("div",{innerHTML:o})),P.recache(cur.offset,-1),--cur.count,cur.count<2&&(0,s.hide)("album_thumb_action")}cur.photoAddUpdate&&cur.photoAddUpdate(i),cur.introTooltipHide&&cur.introTooltipHide(!0),(0,s.ge)("photos_go_to_album_cont")&&(0,s.toggle)("photos_go_to_album_cont",!!cur.count)}},onFail:function(e){if(P.hideMove(),e)return setTimeout((0,g.showFastBox)({title:v.getLang("global_error"),bodyStyle:"padding: 20px;"},e).hide,2e3),!0},showProgress:i,hideProgress:r})},updateThumbs(e,t){var o=(0,s.ge)("photos_add_img"+cur.peEditPhoto);o&&(o.src=e)},editPhoto(e,t,o){cur.peEditPhoto=e,(0,g.showBox)("al_photos.php",{act:"edit_photo",photo:e,webgl:1,stat:["ui_controls.css","ui_controls.js"]})},backupDesc(e){cur.descs||(cur.descs={}),cur.descs[e]=(0,c.trim)((0,s.ge)("photo_caption"+e).value)},saveDesc(e,t){var o=(0,s.ge)("photo_caption"+e).value,i=cur.descs[e];delete cur.descs[e],(0,c.trim)(o)!=i&&ajax.post("al_photos.php",{act:"save_desc",photo:e,hash:t,text:o,edit:1},{onDone:function(t){(0,s.ge)("photo_save_result"+e).innerHTML=t},onFail:function(t){return(0,s.ge)("photo_save_result"+e).innerHTML='<div class="photo_save_error">'+t+"</div>",!0},showProgress:function(){(0,s.ge)("photo_save_result"+e).innerHTML=v.getLang("photos_privacy_description"),(0,s.show)("photo_save_progress"+e)},hideProgress:function(){(0,s.hide)("photo_save_progress"+e)}})},genFile:(e,t,o)=>(0,s.ce)("div",{innerHTML:`\n        <a class="photo_file_cancel" id="photo_cancel${e}" onclick="${t}">${o}</a>\n        <div class="photo_file_button">\n          <div class="file_button_gray">\n            <div class="file_button" id="photo_file_button${e}">${v.getLang("photos_choose_file")}</div>\n          </div>\n        </div>\n      `}),initFile(e){FileButton.init("photo_file_button"+e,{name:"photo",id:"photo_file"+e,accept:"image/jpeg,image/png,image/gif",onchange:P.fileSelected})},addFile(){var e=cur.files.length,t=P.genFile(e,"photos.fileCancel("+e+")",v.getLang("global_cancel"));(0,c.extend)(t,{className:"photo_upload_file",id:"photo_upload_row"+e}),(0,s.ge)("photo_upload_files").appendChild(t),P.initFile(e),cur.files.push({})},filesLoad(){for(var e=0,t=0;e<cur.files.length;++e){if((0,s.ge)("photo_file"+e).value)break}if(e!=cur.files.length){cur.allcont=utilsNode.appendChild((0,s.ce)("div",{innerHTML:`\n        <iframe name="photo_frame_all"></iframe>\n        <form target="photo_frame_all" id="photo_form_all" method="POST" action="${cur.url}" enctype="multipart/form-data"></form>\n      `}));var o=(0,s.ge)("photo_form_all"),i=(0,c.extend)(cur.fields,{act:"do_add",al:1,from_host:locHost,ondone:"photos.filesDone",onfail:"photos.filesFail"});for(t in i)i.hasOwnProperty(t)&&o.appendChild((0,s.ce)("input",{name:t,value:i[t]}));for(e=0,t=0;e<cur.files.length;++e){var r=(0,s.ge)("photo_file"+e);r.value&&(r.name="file"+t,o.appendChild(r),++t)}o.submit()}},fileSelected(){var e=(0,c.intval)(this.id.replace("photo_file",""));if(cur.files[e].deleting||!cur.files[e].cont&&!cur.files[e].id){cur["fileDone"+e]=P.fileDone.pbind(e),cur["fileFail"+e]=P.fileFail.pbind(e),cur.files[e].cont=utilsNode.appendChild((0,s.ce)("div",{innerHTML:`\n        <iframe name="photo_frame${e}"></iframe>\n        <form target="photo_frame${e}" id="photo_form${e}" method="POST" action="${cur.url}" enctype="multipart/form-data"></form>\n      `}));var t=(0,s.ge)("photo_form"+e),o=(0,c.extend)(cur.fields,{act:"do_add",al:1,from_host:locHost,ondone:"cur.fileDone"+e,onfail:"cur.fileFail"+e});for(var i in o)o.hasOwnProperty(i)&&t.appendChild((0,s.ce)("input",{name:i,value:o[i]}));t.appendChild(this),t.submit();var r=(0,s.ge)("photo_file_button"+e);(0,p.lockButton)(r),setTimeout((function(){r.innerHTML=r.innerHTML}),0),(0,s.show)("photo_cancel"+e),(0,s.ge)("photo_cancel"+e).innerHTML=v.getLang("global_cancel"),e==cur.files.length-1&&P.addFile()}},fileDone(e,t){(0,s.hide)("photo_cancel"+e);for(var o="",i=e+1;i<cur.files.length;++i)if(cur.files[i].id&&!cur.files[i].deleting){o=cur.files[i].id;break}setTimeout(ajax.post.pbind("al_photos.php",(0,c.extend)({act:"done_add",before:o,context:1},(0,b.fromQueryString)(t)),{onDone:function(t,o){if(!t)return P.fileFail(e,0);cur.files[e].cont.innerHTML="",utilsNode.removeChild(cur.files[e].cont),(0,c.extend)(cur.files[e],{id:t,deleting:!1,cont:!1}),(0,s.ge)("photo_upload_row"+e).innerHTML=o,(0,l.autosizeSetup)("photo_caption"+t,{minHeight:30}),(0,s.show)("photo_delete"+t)},onFail:function(t){if(t)return setTimeout((0,g.showFastBox)({title:v.getLang("global_error"),bodyStyle:"padding: 20px;"},t).hide,3e3),P.fileCancel(e),!0}}),0)},fileCancel(e,t){if(cur.files[e].cont&&(cur.files[e].cont.innerHTML="",utilsNode.removeChild(cur.files[e].cont)),!t){var o=(0,s.ge)("photo_file_button"+e);(0,p.unlockButton)(o),o.innerHTML=v.getLang("photos_choose_file"),cur.files[e]={},P.initFile(e),(0,s.hide)("photo_cancel"+e)}},fileFail(e,t){P.fileCancel(e)},fileDelete(e,t){for(var o=0;o<cur.files.length&&cur.files[o].id!=e;)++o;if(o!=cur.files.length&&!cur.files[o].deleting){cur.files[o].deleting=!0,ajax.post("al_photos.php",{act:"delete_photo",photo:e,hash:t,edit:2},{onFail:function(){cur.files[o].deleting=!1}});var i=(0,s.ge)("photo_edit_row"+e);i.parentNode.insertBefore(P.genFile(o,"photos.fileRestore('"+e+"', '"+t+"')",v.getLang("global_restore")),i),(0,s.hide)(i),P.initFile(o),(0,s.show)("photo_cancel"+o)}},fileRestore(e,t){for(var o=0,i="";o<cur.files.length&&cur.files[o].id!=e;)++o;if(o!=cur.files.length&&cur.files[o].deleting&&-1!==cur.files[o].deleting){if(cur.files[o].cont)return P.fileCancel(o);for(var r=o+1;r<cur.files.length;++r)if(cur.files[r].id&&!cur.files[r].deleting){i=cur.files[r].id;break}cur.files[o].deleting=-1,ajax.post("al_photos.php",{act:"restore_photo",photo:e,hash:t,before:i,edit:2},{onDone:function(){cur.files[o].deleting=!1}});var a=(0,s.ge)("photo_edit_row"+e);(0,s.show)(a),(0,s.re)(a.previousSibling)}},filesDone(e){setTimeout(ajax.post.pbind("al_photos.php",(0,c.extend)({act:"done_add",context:2},(0,b.fromQueryString)(e))),0)},filesFail(){for(var e=0;e<cur.files.length;++e)P.fileCancel(e);cur.allcont.innerHTML="",utilsNode.removeChild(cur.allcont),cur.allcont=!1},chooseFlash(){if(i.browser.flash<10)return(0,a.animate)((0,s.ge)("photo_flash_needed"),{backgroundColor:"#FFEFE8",borderBottomColor:"#E89B88",borderLeftColor:"#E89B88",borderRightColor:"#E89B88",borderTopColor:"#E89B88"},100,(()=>{(0,a.animate)((0,s.ge)("photo_flash_needed"),{backgroundColor:"#FFFFFF",borderBottomColor:"#CCCCCC",borderLeftColor:"#CCCCCC",borderRightColor:"#CCCCCC",borderTopColor:"#CCCCCC"},500)}));cur.photoCheckFails=0,(0,s.show)("photo_flash_upload"),(0,s.hide)("photo_default_upload"),(0,s.hide)("photo_upload_unavailable")},chooseDefault(){cur.photoCheckFails=0,(0,s.show)("photo_default_upload"),(0,s.hide)("photo_flash_upload"),cur.serverChecked?((0,s.show)("photo_upload_files"),(0,s.hide)("photo_default_check")):((0,s.hide)("photo_upload_files"),(0,s.show)("photo_default_check"),cur.checkUpload())},flashWidth:()=>-1==_ua.indexOf("Mac")||-1==_ua.indexOf("Opera")&&-1==_ua.indexOf("Firefox")?"600":"601",activeTab(e){for(var t=(0,s.domPN)((0,s.domPN)(e)),o=(0,s.domFC)(t);o;o=(0,s.domNS)(o))(0,s.removeClass)(o,"active_link");(0,s.addClass)((0,s.domPN)(e),"active_link")},checkHtml5Uploader(){var e=window.XMLHttpRequest||window.XDomainRequest,t=window.MozBlobBuilder||window.WebKitBlobBuilder||window.BlobBuilder;return e&&(window.FormData||window.FileReader&&(window.XMLHttpRequest&&XMLHttpRequest.sendAsBinary||window.ArrayBuffer&&window.Uint8Array&&t))},upload:(e,t)=>t&&(2==t.button||t.ctrlKey)?(P.checkHtml5Uploader()&&(e.href+="&html5=1"),!0):!(void 0!==cur.uplId&&window.Upload&&Upload.checked&&Upload.checked[cur.uplId]&&P.checkHtml5Uploader())||((0,s.ge)("photos_upload_input").click(),!1),uploadLink:(e,t)=>(P.checkHtml5Uploader()&&(e.href+="&html5=1"),nav.go(e,t)),onUploadSelect(e){if((0,s.ge)("photos_upload_area")){window.filesToUpload=e;var t=(0,s.ge)("photos_upload_area").innerHTML;(0,s.ge)("photos_upload_area").innerHTML='<img src="/images/upload.gif">',nav.go((0,s.ge)("photos_upload_area").href+"&html5=1",!1,{onFail:function(e){return(0,s.ge)("photos_upload_area").innerHTML=t,setTimeout((0,g.showFastBox)({title:v.getLang("global_error"),bodyStyle:"padding: 20px;"},e).hide,3e3),!0}})}},thumbOver(e,t,o){cur.hideTO&&cur.hideTO[t]&&clearTimeout(cur.hideTO[t]);var i=(0,s.geByClass1)("description",e),r=(0,s.geByClass1)("photo_album_title",e),n=(0,s.getSize)(i)[1];(0,a.animate)(r,{marginTop:163-(n?n+7:0)},{duration:200,transition:a.Fx.Transitions.easeOutCirc});var l=(0,s.geByClass1)("photo_album_info_back",e),d=(0,s.geByClass1)("photo_album_info_cont",e);if(l&&d)if(!l.over||o){var h=o?.6:.5,c=o?1:.8;o&&(l.over=1),(0,a.animate)(l,{opacity:h},{duration:200,transition:a.Fx.Transitions.easeOutCirc}),(0,a.animate)(d,{opacity:c},{duration:200,transition:a.Fx.Transitions.easeOutCirc})}else l.over=0},thumbOut(e,t,o){var i=(0,s.geByClass1)("photo_album_info_back",e),r=(0,s.geByClass1)("photo_album_info_cont",e),n=()=>{if(o){var t=(0,s.geByClass1)("photo_album_title",e);(0,a.animate)(t,{marginTop:163},200)}if(i&&r){var n=o?0:.5,l=o?0:.8;(0,a.animate)(i,{opacity:n},200),(0,a.animate)(r,{opacity:l},200)}};o?(cur.hideTO=cur.hideTO||{},cur.hideTO[t]=setTimeout(n,150)):n()},openEditor:(e,t)=>(window.stManager.add([window.jsc("web/photoview.js"),"photoview.css"],(function(){var t=(0,s.gpeByClass)("photos_photo_edit_row",e);cur.onPESave=function(e){(0,d.curBox)().hide(),(0,s.setStyle)((0,s.geByClass1)("photos_photo_edit_row_thumb",t),"background-image","url('"+e+"')"),cur.onPESave=!1,document.body.style.overflow="auto"};var o=t.getAttribute("data-id");Photoview.openEditor(o,cur.savedThumbs?cur.savedThumbs[o]:t.getAttribute("data-thumb"))})),(0,h.cancelEvent)(t)),addToAlbum(){cur.isPhotoUpload=!0,P.movePhotosBox(cur.savedPhotos||[],!1)},movePhotosBox(e,t,o,i){var a=[],n=!1;(0,r.isArray)(e)?a=e:(""===e&&t&&(e=(0,s.gpeByClass)("photos_photo_edit_row",t).getAttribute("data-id")),e?a.push(e):(0,c.each)((0,s.geByClass)("photos_edit_selected"),(function(){a.push(this.getAttribute("data-id"))})),n=(0,c.intval)(P._editGetSelectedCount()>a.length));var l=cur.album?cur.album.split("_"):[vk.id];return(0,g.showBox)("/al_photos.php",{act:"a_move_to_album_box",photo_ids:n?"":a.join(","),owner_id:l[0],from_album_id:l[1],all:n},{onDone:o}),(0,h.cancelEvent)(i)},cancelMove(e,t,o,i,r,a,n){var l=(0,s.gpeByClass)("photos_photo_edit_row",t);(0,s.re)((0,s.geByClass1)("photos_cancel_move",l)),P._showProgressPanel(l),ajax.post("al_photos.php",{act:"move_photos",photos:o,to_album_id:i,from_album_id:r,hash:n,owner_id:a},{onDone:function(){P._hideProgressPanel(l),cur.count++,P._editUpdateSelectedCounter()}}),(0,h.cancelEvent)(e)},doMovePhotos(e,t,o){var i=(0,s.domClosest)("_photos_album",t),r=(0,s.domData)(i,"aid"),a=(0,s.domData)(i,"from-aid"),n=(0,s.domData)(i,"owner-id"),l=(0,s.domData)(i,"move-hash"),u=(0,s.domData)(i,"from"),p=(0,s.geByClass1)("photos_album_counter",t),g=(0,s.geByClass1)("photos_album_thumb",t),_=(0,s.ge)("pv_move_to_album_progress");g.insertBefore(_,g.children[0]),(0,s.show)(_),(0,s.addClass)(t,"photos_in_progress"),(0,s.addClass)((0,s.gpeByClass)("photos_container_albums",t),"photos_inactive"),P.doEditBatchProcess({act:"move_photos",to_album_id:r,from_album_id:a,owner_id:n,hash:l,from:u},cur.editPhotosArray,(0,s.ge)("pv_move_to_album_progress"),v.getLang("photos_move_in_progress_title"),(function(e,t,i,l,d,h){cur.count=Math.max(cur.count-e,0),(0,s.val)(p,+(0,s.val)(p)+e),(0,c.each)(i,(function(e,t){var i=(0,s.ge)("photo_edit_row_"+t);if(!cur.isPhotoUpload)if(i&&!o){var l="return photos.cancelMove(event, this, '"+t+"', "+a+", "+r+", "+n+", '"+h+"')",d=(0,s.se)(`<div class="photos_cancel_move">\n                <div class="photos_editing_background"></div>\n                <a href="" onclick="${l}">${v.getLang("global_cancel")}</a></div>`);i.appendChild(d)}else(0,s.re)(i);cur.count=Math.max(cur.count,0)})),P._editUpdateSelectedCounter()}),(function(e,t){var i=(0,d.curBox)();i&&i.hide();var r=(0,v.langNumeric)(e,v.curLang("photos_x_photos_moved_no_cancel"));(r=r.replace("{album}",t),(0,d.showDoneBox)(r),cur.pvShown&&cur.pvCurPhoto&&(cur.pvCurPhoto.album=t,(0,s.geByClass1)("pv_album_name").innerHTML=t),o||cur.isPhotoUpload)&&(0==cur.count?nav.reload():(0,s.geByClass)("photos_photo_edit_row").length<40&&P.load())})),e&&(0,h.cancelEvent)(e)},publishPhotos(e){if(cur.savedPhotos){cur.savingPhotos=!0;var t={act:"post",type:"photos_upload",to_id:vk.id,attach1_type:"photos_list",attach1:(cur.savedPhotos||[]).join(","),hash:cur.post_hash};ajax.post("/al_wall.php",t,{showProgress:()=>(0,p.lockButton)(e),onDone:function(){delete cur._back,nav.go("/id"+vk.id),(0,n.showBackLink)()}})}return!1},registerDragZone(e){(0,h.addEvent)(document,"dragenter dragover",(function(t){if(P.checkHtml5Uploader())return setTimeout((function(){clearTimeout(cur.dragTimer),delete cur.dragTimer}),0),e.on(t),(0,h.cancelEvent)(t)})),(0,h.addEvent)(document,"dragleave",(function(t){cur.dragTimer&&(clearTimeout(cur.dragTimer),delete cur.dragTimer),cur.dragTimer=setTimeout((function(){e.un(t)}),100),(0,h.cancelEvent)(t)})),(0,h.addEvent)(document,"drop",(function(t){return e.un(t,!0),e.drop(t.dataTransfer.files),(0,h.cancelEvent)(t)})),(0,T.pushNavDestroy)((()=>{(0,h.removeEvent)(document,"dragenter dragover"),(0,h.removeEvent)(document,"dragleave"),(0,h.removeEvent)(document,"drop")}))},initTagBlock(e){void 0===e&&(e={});var t=document.querySelector(`.${_.PHOTO_TAG_BLOCK_CLASS}`);if(t)try{var o=new _.PhotoTagBlock(t,e);window.cur.destroy.push((()=>o.destroy()))}catch(e){console.error(e),(0,m.logError)(e)}},albumGoUploaderPropsCache:{},initAlbumGoUploader(e,t){void 0===t&&(t=null);var o=t||this.albumGoUploaderPropsCache[e];if(o){this.albumGoUploaderPropsCache[e]=o;var i=o.userId,r=o.groupId,a=o.albumId,n=o.uploadUrl,l=o.endpoint,d=o.curData;d&&(0,c.extend)(window.cur,d);var h=(0,s.ge)("photos_upload_input"),u=(0,s.ge)("photos_upload_area_drop"),p=[],g=w.ImpUploader.init(e,{uploadUrl:n,accept:E.ALBUM_GO_UPLOADER_ACCEPT_TYPES,multiple:!0,input:h,dropArea:u,dragOverClass:"photos_upload_area_enter",onLoadStart:e=>{p.length=0,(0,s.hide)("system_msg"),window.PhotosAdd.onUploadStart(e)},onProgress:e=>{Array.from((0,s.geByClass)("photos_period_delimiter_fixed")).forEach(s.hide),_()},onLoadEnd:(e,t)=>{var o=t[0],s={group_id:r,album_id:a,user_id:i,photos_json:JSON.stringify(o)};window.PhotosAdd.onImpUploadComplete(e,s,l,(()=>{p.push(...e),_(),g.nextBatch()}))},onLoadEndAll:(e,t)=>{window.PhotosAdd.onUploadCompleteAll(e,t,!1)},onError:(e,t,o)=>{(0,m.logError)(`${t}: ${o}`,{environment:"go_uploader"}),(0,f.topError)(v.getLang("photos_upload_error"),{type:100});window.PhotosAdd.onImpUploadComplete(e,{},l),window.PhotosAdd.onUploadCompleteAll(null,null)}});window.photos.initAlbumGoUploaderDragZone(e),cur.nav.push((()=>(g.cancelAllUploads(),!0))),window.filesToUpload&&window.filesToUpload.length&&(g.manualUploadFiles([...window.filesToUpload]),delete window.filesToUpload)}function _(){var e=g.uploadedFiles.length,t=g.uploadedFiles[0].loadedSize,o=g.uploadedFiles[0].totalSize,i=p.length;if(i===e)window.PhotosAdd.hideUploadProgress(),(0,s.show)((0,s.ge)("photos_go_to_album"));else{var r=.1*(t/o)+.9*(i/e);window.PhotosAdd.updateProgressBar(r,i,e)}}},initAlbumGoUploaderDragZone(e){var t=w.ImpUploader.getUploader(e);this.onAlbumGoUploaderDragEnter=e=>{t.handleDragEnter(e)},window.document.addEventListener("dragenter",this.onAlbumGoUploaderDragEnter)},detachAlbumGoUploaderDragZone(){window.document.removeEventListener("dragenter",this.onAlbumGoUploaderDragEnter)},initChooseSelectGoUploader(e){var t=e.id,o=e.userId,s=e.groupId,i=e.albumId,r=e.uploadUrl,a=e.options,n=void 0===a?{}:a;new C.ChoosePhoto.Upload({id:t,userId:o,groupId:s,albumId:i,uploadUrl:r,options:n})},showProfileBox:(e,t)=>((0,g.showBox)("al_places.php",{act:"photos_box",uid:e},{stat:["maps.js",window.jsc("web/places.js"),"places.css","ui_controls.js","ui_controls.css"]}),(0,h.cancelEvent)(t),!1),photosUploadOnInputChange:e=>{var t=window.cur.album,o=w.ImpUploader.getUploader(null!=t?t:"");e&&o?o.handleInputChange(e):(0,m.logError)(new Error(`Uploader "${t}" did not found`),{environment:"go_uploader"})}}},59266:(e,t,o)=>{"use strict";o.d(t,{GoUploaderDnD:()=>l});var s=o(665641),i=o(651315),r=o(533321),a=o(192206);class n{constructor(e){var t,o;this.multipleMaxSize=a.MULTIPLE_MAX_COUNT,this.multipleMaxBatchSize=a.MULTIPLE_BATCH_SIZE,this.uploadUrl="",this.uploadEvents=[],this.uploadMode=s.UploadMode.queue,this.uploaderTasksQueue=[],this.handleInputChange=e=>{const t=e.target.files;if(!t||0===t.length)return void(0,r.logError)(new Error("GoUploader lib: bad args in handleInputChange"),"No files in event");const o=this.getAcceptedFilesOnly(t);this.manualUploadFiles(o)},this.accept=null!==(t=e.accept)&&void 0!==t?t:a.DEFAULT_ACCEPT,this.multiple=null!==(o=e.multiple)&&void 0!==o&&o,this.uploadUrl=e.uploadUrl,this.onBeforeUpload=e.onBeforeUpload,this.onProgress=e.onProgress,this.onLoadStart=e.onLoadStart,this.onLoadEnd=e.onLoadEnd,this.onLoadEndAll=e.onLoadEndAll,this.onError=e.onError,e.input&&this.initFileInput(e.input),e.multipleMaxSize&&e.multipleMaxSize>0&&e.multipleMaxSize<=a.MULTIPLE_MAX_COUNT&&(this.multipleMaxSize=e.multipleMaxSize),e.multipleMaxBatchSize&&(this.multipleMaxBatchSize=e.multipleMaxBatchSize)}cancelUpload(e){e.cancelled=!0}cancelAllUploads(){this.uploadEvents.forEach((e=>{this.cancelUpload(e)}))}startFilesUpload(e,t){const o=this.multiple?this.multipleMaxSize:1,i=t.reduce(((e,t)=>{if(!e.length)return e.push([t]),e;const s=e.length-1,i=e[s].length,r=e[s].reduce(((e,t)=>e+=t.size),0);return i<o&&r<this.multipleMaxBatchSize?e[s].push(t):e.push([t]),e}),[]);let r=0;this.uploadEvents=i.map((e=>{let t=0;const o=e.reduce(((e,o,s)=>{const i=this.multiple?`file${s+1}`:"file";return t+=o.size,r++,e[i]={file:o,fileName:o.name,ind:r,loadedSize:0,fileSize:o.size},e}),{});return{totalSize:t,loadedSize:0,totalCount:e.length,uploaded:!1,cancelled:!1,files:o}})),this.onLoadStart&&this.uploadEvents.forEach((e=>{var t;null===(t=this.onLoadStart)||void 0===t||t.call(this,e)}));const a=[];return this.uploadMode===s.UploadMode.parallel?this.uploadEvents.forEach((t=>{a.push(this.sendUploadRequest(e,t))})):(this.uploadEvents.forEach((t=>{a.push(new Promise((o=>{this.uploaderTasksQueue.push((()=>this.sendUploadRequest(e,t).then((e=>(o(e),e)))))})))})),this.nextBatch()),Promise.all(a)}nextBatch(){const e=this.uploaderTasksQueue.shift();e&&e()}sendUploadRequest(e,t){const o=new FormData;Object.keys(t.files).forEach((e=>{const s=t.files[e];o.append(e,s.file)}));return(0,i.sendUploadRequest)(e,o,(e=>{var o;let{loaded:s}=e;t.loadedSize=s,Object.keys(t.files).forEach((e=>{const o=t.files[e];if(s>0){let e=0;s>=o.fileSize?(e=o.fileSize,s-=o.fileSize):(e=s,s=0),o.loadedSize=e}})),null===(o=this.onProgress)||void 0===o||o.call(this,t)})).then((e=>{var o,s;let i;t.uploaded=!0;try{i=JSON.parse(e)}catch(t){(0,r.logError)(t,"parse json error",{json:e}),i={error_code:n.ERROR_PARSE_JSON,error_msg:"Response parse error"}}return t.responseString=e,t.response=i,"files"in i&&i.files&&Object.keys(i.files).forEach((e=>{var o,s,r;"files"in i&&i.files&&(null===(o=i.files[e])||void 0===o?void 0:o.error_code)&&(t.files[e].errorCode=null===(s=i.files[e])||void 0===s?void 0:s.error_code,t.files[e].errorMessage=null===(r=i.files[e])||void 0===r?void 0:r.error_msg)})),"error_code"in i?(t.errorCode=i.error_code,t.errorMessage=i.error_msg,null===(o=this.onError)||void 0===o||o.call(this,t)):null===(s=this.onLoadEnd)||void 0===s||s.call(this,t),t})).catch((e=>((0,r.logError)(e,"js syntax error"),t.errorCode=n.ERROR_JS,t.errorMessage=`Unknown Error (${e})`,t)))}initFileInput(e){this.input=e,this.input.setAttribute("accept",this.accept.join(",")),this.multiple&&this.input.setAttribute("multiple","")}getAcceptedFilesOnly(e){return Array.from(e).filter((e=>(0,r.acceptFile)(e,this.accept)))}cleanupFields(){this.input&&(this.input.value=""),this.uploadEvents=[]}uploadFiles(e){return this.beforeUpload(e).then((e=>this.startFilesUpload(this.uploadUrl,e)))}beforeUpload(e){return this.onBeforeUpload?this.onBeforeUpload(e):Promise.resolve(e)}manualUploadFiles(e){e.length?this.uploadFiles(e).then((e=>{var t;this.uploadEvents.filter((e=>!e.cancelled)).length&&(null===(t=this.onLoadEndAll)||void 0===t||t.call(this,e))})).finally((()=>{this.cleanupFields()})):this.cleanupFields()}destroy(){}}n.ERROR_JS=-1,n.ERROR_PARSE_JSON=-2;class l extends n{constructor(e){var t;super(e),this.isDndActive=!1,this.dndTimer=-1,this.handleDrop=e=>{if(e.preventDefault(),e.stopPropagation(),this.onDragLeave&&this.onDragLeave(e),this.isDndActive=!1,!e.dataTransfer)return;const t=this.getAcceptedFilesOnly(e.dataTransfer.files);this.manualUploadFiles(t)},this.handleDragOver=e=>{e.preventDefault(),e.stopPropagation(),window.setTimeout((()=>{window.clearTimeout(this.dndTimer),this.dndTimer=-1}),0)},this.handleDragLeave=e=>{e.preventDefault(),e.stopPropagation(),-1!==this.dndTimer&&window.clearTimeout(this.dndTimer),this.dndTimer=window.setTimeout((()=>{this.isDndActive=!1,this.onDragLeave&&this.onDragLeave(e)}),100)},this.handleDragEnter=e=>{e.preventDefault(),e.stopPropagation(),this.isDndActive||(window.setTimeout((()=>{window.clearTimeout(this.dndTimer),this.dndTimer=-1}),0),this.isDndActive=!0,this.onDragEnter&&this.onDragEnter(e))},this.lazyInitDnD=null!==(t=e.lazyInitDnD)&&void 0!==t&&t,e.dropArea&&!this.lazyInitDnD&&this.initDropArea(e.dropArea),e.onDragEnter&&(this.onDragEnter=e.onDragEnter),e.onDragLeave&&(this.onDragLeave=e.onDragLeave)}initDropArea(e){e&&(this.dropArea=e,this.dropArea.addEventListener("dragleave",this.handleDragLeave),this.dropArea.addEventListener("dragenter",this.handleDragEnter),this.dropArea.addEventListener("dragover",this.handleDragOver),this.dropArea.addEventListener("drop",this.handleDrop))}destroy(){super.destroy(),this.dropArea&&(this.dropArea.removeEventListener("dragleave",this.handleDragLeave),this.dropArea.removeEventListener("dragenter",this.handleDragEnter),this.dropArea.removeEventListener("dragover",this.handleDragOver),this.dropArea.removeEventListener("drop",this.handleDrop))}}},192206:(e,t,o)=>{"use strict";o.d(t,{DEFAULT_ACCEPT:()=>s,MULTIPLE_BATCH_SIZE:()=>i,MULTIPLE_MAX_COUNT:()=>r});const s=["image/jpeg","image/png","image/gif","image/heic","image/heif","image/webp"],i=5242880,r=5},533321:(e,t,o)=>{"use strict";o.d(t,{ALBUM_GO_UPLOADER_ACCEPT_TYPES:()=>r,logError:()=>a,acceptFile:()=>n});var s=o(66433),i=o(209509);const r=["image/jpeg","image/png","image/gif","image/heic","image/heif","image/webp"],a=(e,t="unknown",o={})=>{const r={environment:"goUploader",breadcrumb:{message:t,data:o,category:i.customBreadcrumbCategory}};(0,s.logError)(e,r)},n=(e,t)=>{if(e&&t){const o=e.name||"",s=e.type?e.type.toLowerCase():(e=>{let t="";if(e){const o=(e.split(".").pop()||"").toLowerCase();"heic"===o?t="image/heic":"heif"===o&&(t="image/heif")}return t})(o),i=s.replace(/\/.*$/,"");return t.some((e=>{const t=e.trim().toLowerCase();return t.startsWith(".")?o.toLowerCase().endsWith(t):t.endsWith("/*")?i===t.replace(/\/.*$/,""):s===t}))}return!0}},908069:(e,t,o)=>{"use strict";o.d(t,{GoUploaderHelper:()=>r});var s=o(59266);const i=new Map,r={getUploader:e=>i.get(e),init(e,t){if(i.has(e)){const t=i.get(e);t&&t.destroy()}const o=new s.GoUploaderDnD(t);return i.set(e,o),o}}},665641:(e,t,o)=>{"use strict";var s;o.d(t,{UploadMode:()=>s}),function(e){e[e.parallel=0]="parallel",e[e.queue=1]="queue"}(s||(s={}))},651315:(e,t,o)=>{"use strict";o.d(t,{sendUploadRequest:()=>s});const s=(e,t,o)=>new Promise(((s,i)=>{const r=new XMLHttpRequest;r.open("POST",e,!0),r.upload.onloadstart=e=>{o(e)},r.upload.onprogress=e=>{o(e)},r.onerror=()=>{i("Unknown error")},r.onreadystatechange=()=>{r.readyState===XMLHttpRequest.DONE&&(200===r.status?s(r.responseText):i())},r.send(t)}))},112119:(e,t,o)=>{"use strict";o.d(t,{ImageProxyUploader:()=>n});var s=o(38339),i=o(134429),r=o(200795),a=o(873589);class n{constructor(e){var t,o,i;this.uploadUrl="",this.uploadedFiles=[],this.uploadMode=s.UploadMode.queue,this.uploadRequests=[],this.uploaderTasksQueue=[],this.isDndActive=!1,this.dndTimer=-1,this.handleDrop=e=>{var t;if(e.preventDefault(),e.stopPropagation(),this.dragOverClass&&((0,a.hide)(this.dropArea),null===(t=this.dropArea)||void 0===t||t.classList.remove(this.dragOverClass)),this.isDndActive=!1,!e.dataTransfer)return;const o=this.getAcceptedFilesOnly(e.dataTransfer.files);this.manualUploadFiles(o)},this.handleInputChange=e=>{const t=e.target.files;if(!t||0===t.length)return;const o=this.getAcceptedFilesOnly(t);this.manualUploadFiles(o)},this.handleDragOver=e=>{e.preventDefault(),e.stopPropagation(),window.setTimeout((()=>{window.clearTimeout(this.dndTimer),this.dndTimer=-1}),0)},this.handleDragLeave=e=>{e.preventDefault(),e.stopPropagation(),-1!==this.dndTimer&&window.clearTimeout(this.dndTimer),this.dndTimer=window.setTimeout((()=>{var e;this.isDndActive=!1,this.dragOverClass&&((0,a.hide)(this.dropArea),null===(e=this.dropArea)||void 0===e||e.classList.remove(this.dragOverClass))}),100)},this.handleDragEnter=e=>{var t;e.preventDefault(),e.stopPropagation(),this.isDndActive||(window.setTimeout((()=>{window.clearTimeout(this.dndTimer),this.dndTimer=-1}),0),this.isDndActive=!0,this.dragOverClass&&(null===(t=this.dropArea)||void 0===t||t.classList.add(this.dragOverClass),(0,a.show)(this.dropArea)))},this.accept=null!==(t=e.accept)&&void 0!==t?t:["image/*"],this.multiple=null!==(o=e.multiple)&&void 0!==o&&o,this.dragOverClass=e.dragOverClass,this.uploadUrl=e.uploadUrl,this.uploadMode=null!==(i=e.uploadMode)&&void 0!==i?i:s.UploadMode.queue,this.onProgress=e.onProgress,this.onLoadStart=e.onLoadStart,this.onLoadEnd=e.onLoadEnd,this.onLoadEndAll=e.onLoadEndAll,this.onError=e.onError,e.input&&this.initFileInput(e.input),e.dropArea&&this.initDropArea(e.dropArea)}cancelUpload(e){e.cancelled=!0}cancelAllUploads(){this.uploadedFiles.forEach((e=>{this.cancelUpload(e)}))}nextBatch(){const e=this.uploaderTasksQueue.shift();e&&e()}sendFilesUploadEvent(e,t){const o=this.uploadedFiles,s=this.uploadRequests.reduce(((e,t)=>e+t.loadedBytes),0),i=this.uploadRequests.reduce(((e,t)=>e+t.totalBytes),0);o.forEach((r=>{r.cancelled||(Object.assign(r,{loadedSize:s,totalCount:o.length,totalSize:i}),e(r,t))}))}startFilesUpload(e,t){this.uploadedFiles=t.map(((e,o)=>({file:e,fileName:e.name,ind:0,loadedSize:0,num:o,totalCount:t.length,totalSize:e.size,uploaded:!1,error:void 0,cancelled:!1}))),this.onLoadStart&&this.sendFilesUploadEvent(this.onLoadStart);const o=[...this.uploadedFiles],i=[];for(;o.length;){const t=[];let s=0;for(let e=0;e<5&&0!==o.length;e++){const e=o.shift();if(!e)break;if(s+=e.file.size,t.push(e),s>5242880)break}t.length&&i.push((()=>this.sendUploadRequest(e,t)))}const r=[];return this.uploadMode===s.UploadMode.parallel?i.forEach((e=>{r.push(e())})):(i.forEach((e=>{r.push(new Promise((t=>{this.uploaderTasksQueue.push((()=>e().then((e=>(t(e),e)))))})))})),this.nextBatch()),Promise.all(r)}sendUploadRequest(e,t){const o=new FormData,s={loadedBytes:0,totalBytes:0};this.uploadRequests.push(s);for(let e=0;e<t.length;e++){const s=t[e];o.append(`file${e+1}`,s.file)}return(0,i.sendUploadRequest)(e,o,s,(()=>{this.onProgress&&this.sendFilesUploadEvent(this.onProgress)})).then((e=>{let o;t.forEach((e=>{e.uploaded=!0}));try{o=JSON.parse(e)}catch(e){throw Error("Uploader response parsing error")}return Object.values(o.files).forEach(((e,s)=>{e&&(this.saveUploaderStateToFileState(t[s],e),Object.assign(t[s],{server:o.server,userId:o.user_id}),s++)})),this.onLoadEnd&&t.length&&this.onLoadEnd(t,[o]),e})).catch((e=>(t.forEach((t=>{t.errorMessage=e})),e)))}initFileInput(e){this.input=e,this.input.setAttribute("accept",this.accept.join(",")),this.multiple&&this.input.setAttribute("multiple","")}initDropArea(e){var t,o,s;this.dropArea=e,null===(t=this.dropArea)||void 0===t||t.addEventListener("dragleave",this.handleDragLeave),null===(o=this.dropArea)||void 0===o||o.addEventListener("dragover",this.handleDragOver),null===(s=this.dropArea)||void 0===s||s.addEventListener("drop",this.handleDrop)}destroy(){var e,t,o;null===(e=this.dropArea)||void 0===e||e.removeEventListener("dragleave",this.handleDragLeave),null===(t=this.dropArea)||void 0===t||t.removeEventListener("dragover",this.handleDragOver),null===(o=this.dropArea)||void 0===o||o.removeEventListener("drop",this.handleDrop)}getAcceptedFilesOnly(e){return[...e].filter((e=>(0,r.acceptFile)(e,this.accept)))}cleanupFields(){this.input&&(this.input.value=""),this.uploadRequests=[]}handleError(e){var t,o;let s=0,i="unknown error";if("string"==typeof e)try{const r=JSON.parse(e);s=null!==(t=r.error_code)&&void 0!==t?t:s,i=null!==(o=r.error_msg)&&void 0!==o?o:i}catch(t){i=e}else i=e.message;this.onError&&this.onError(this.uploadedFiles,s,i)}uploadFiles(e){return this.startFilesUpload(this.uploadUrl,e).then((e=>Promise.all(e.map((e=>{let t;try{t=JSON.parse(e)}catch(e){throw Error("Uploader response parsing error")}return t})))))}saveUploaderStateToFileState(e,t){t&&(t.error_code?Object.assign(e,{errorCode:t.error_code,errorMessage:t.error_msg}):Object.assign(e,{width:+t.meta.width,height:+t.meta.height,kid:t.meta.kid,secret:t.secret,sha:t.sha}))}manualUploadFiles(e){e.length?this.uploadFiles(e).then((e=>{const t=this.uploadedFiles.filter((e=>!e.cancelled));this.onLoadEndAll&&t.length&&this.onLoadEndAll(this.uploadedFiles,e)})).finally((()=>{this.cleanupFields()})).catch((e=>{this.handleError(e)})):this.cleanupFields()}}},200795:(e,t,o)=>{"use strict";o.d(t,{acceptFile:()=>s});const s=(e,t)=>{if(e&&t){const o=e.name||"",s=(e.type||"").toLowerCase(),i=s.replace(/\/.*$/,"");return t.some((e=>{const t=e.trim().toLowerCase();return t.startsWith(".")?o.toLowerCase().endsWith(t):t.endsWith("/*")?i===t.replace(/\/.*$/,""):s===t}))}return!0}},169424:(e,t,o)=>{"use strict";o.d(t,{ImpUploader:()=>r});var s=o(112119);const i=new Map,r={getUploader:e=>i.get(e),init(e,t){if(i.has(e)){const t=i.get(e);t&&t.destroy()}const o=new s.ImageProxyUploader(t);return i.set(e,o),o}}},38339:(e,t,o)=>{"use strict";var s;o.d(t,{UploadMode:()=>s}),function(e){e[e.parallel=0]="parallel",e[e.queue=1]="queue"}(s||(s={}))},134429:(e,t,o)=>{"use strict";o.d(t,{sendUploadRequest:()=>s});const s=(e,t,o,s)=>new Promise(((i,r)=>{const a=new XMLHttpRequest;a.open("POST",e,!0),a.upload.onloadstart=e=>{o.totalBytes+=e.total,s()},a.upload.onprogress=e=>{e.lengthComputable&&(o.loadedBytes=e.loaded,o.totalBytes=e.total),s()},a.onerror=()=>{r("Unknown error")},a.onreadystatechange=()=>{if(a.readyState===XMLHttpRequest.DONE&&200===a.status){if(JSON.parse(a.responseText).error_code)return void r(a.responseText);i(a.responseText)}};const n=(e=>Array.from(e.entries()).reduce(((e,[,t])=>e+("string"==typeof t?t.length:t.size)),0))(t);o.totalBytes=n,a.send(t)}))},569334:(e,t,o)=>{"use strict";o.d(t,{ChoosePhoto:()=>s});const s={Upload:o(552465).ChoosePhotoUpload}},552465:(e,t,o)=>{"use strict";o.d(t,{ChoosePhotoUpload:()=>p});var s=o(873589),i=o(927766),r=o(146143),a=o(514191),n=o(70162),l=o(908069),d=o(665641),h=o(501389),c=o(798262);function u(e){return e.fileName.replace(/[&<>"']/g,"")}class p{constructor(e){this.isUploadCompletedAll=!1,this.id=e.id,this.uploadUrl=e.uploadUrl,this.userId=e.userId,this.albumId=e.albumId,e.groupId&&(this.groupId=e.groupId),e.options&&(this.maxFiles=e.options.max_files||10,this.isWiki=!!e.options.wiki_editor,this.bugCommentEditor=e.options.bugcomments_editor||""),this.init()}beforeUpload(e){const t=window.cur,o=this.maxFiles-(t.savedPhotos||[]).length-(t.attachCount&&t.attachCount()||0);if(o<=0)return Promise.reject(n.getLang("global_error"));if(e.length<=o)return Promise.resolve(e);const s=n.getLang("global_attach_max_n_files",this.maxFiles).replace("{count}",String(this.maxFiles));return new Promise((function(t,i){const a={title:n.getLang("global_error"),width:430,bodyStyle:"padding: 20px; line-height: 160%;"};(0,r.showFastBox)(a,s,n.getLang("global_continue"),(function(){(0,h.curBox)().hide(),t(e.slice(0,o))}),n.getLang("global_cancel"),(function(){(0,h.curBox)().hide(),i("Abort by user")}))}))}removeProgress(e){this.isWiki||Object.keys(e.files).forEach((t=>{var o,s;const i=e.files[t],r=i.ind+"_"+u(i);if(window.__upload_callback&&delete window.__upload_callback[r],window.cur.imMedia){null===(o=document.getElementById(`upload${r}_progress_wrap`))||void 0===o||o.remove();const e=window.cur.imMedia.lnkId;window.cur.addMedia[e].unchooseMedia(!1)}else if(window.cur.addMedia){null===(s=document.getElementById(`upload${r}_progress_wrap`))||void 0===s||s.remove();const e=(window.cur.attachMediaIndexes||{})[r];e&&window.cur.addMedia[e].unchooseMedia(!1)}}))}choosePhotoUploadFailed(e){this.removeProgress(e),this.isWiki||(0,c.statlogsValueEvent)("upload_photo_fails",e.files.length,e.response.server,e.response.error_code),"errorCode"in e&&e.errorCode&&(0,h.showDoneBox)(n.getLang("photos_add_error")+` (${e.errorCode})`),window.cur.onMediaUploadFail&&window.cur.onMediaUploadFail(e.files),this.onUploadCompleted(),this.instance.nextBatch()}choosePhotoUploaded(e){const t=Object.keys(e.files).some((t=>{const o=e.files[t],i=o.ind+"_"+u(o),r=document.getElementById(`upload${i}_progress_wrap`);if(r){const e=(0,s.gpeByClass)("submit_post_box",r);return!!e&&e.classList.contains("reply_box")}return!1}),{}),o=Object.values(e.files);a.ajax.post("al_photos.php",{act:"choose_uploaded",mid:this.userId,gid:this.groupId||0,aid:this.albumId,is_reply:t?1:0,upload_v2:1,bugcomments_editor:this.bugCommentEditor,photos:e.responseString},{onDone:e=>{window.cur.preventBoxHideWithSharedBox=!0,Object.entries(e).forEach((function([e,t],s){const i=o[s];window.cur.chooseMedia("photo",e,Object.assign({upload_ind:i.ind+"_"+i.fileName},t))})),window.cur.preventBoxHideWithSharedBox=!1,this.instance.nextBatch(),this.onUploadCompleted()},onFail:this.choosePhotoUploadFailed.bind(this,e)})}alWysiwygChoosePhotoUploaded(e){var t;a.ajax.post("al_photos.php",{act:"choose_uploaded",mid:this.userId,gid:this.groupId,aid:this.albumId,al_wiki_editor:1,upload_v2:1,photos:e.responseString},{onDone:(e,t,o,s)=>{window.editorChoosePhoto&&window.editorChoosePhoto(e,t,o,s),this.onUploadCompleted(),this.instance.nextBatch()},onFail:this.choosePhotoUploadFailed.bind(this,e),progress:null===(t=(0,h.curBox)())||void 0===t?void 0:t.progress})}uploadProgress(e){if(e.cancelled)return!0;this.isWiki||Object.keys(e.files).forEach((t=>{const o=e.files[t],s=o.ind,i=u(o),r=s+"_"+i,a=(window.cur.attachMediaIndexes||{})[r];if(void 0===a||a&&window.cur.addMedia[a]||window.cur.imMedia){const t={loaded:o.loadedSize,total:o.fileSize,name:i};window.__upload_callback||(window.__upload_callback={}),window.__upload_callback[r]=()=>{this.instance.cancelUpload(e),this.removeProgress(e)},window.cur.showMediaProgress("photo",s,t,!0)}}))}uploadStart(e){if(this.isUploadCompletedAll=!1,this.isWiki){const e=document.getElementById(`photos_choose_upload_area_${this.id}`);e&&(e.innerHTML='<img src="/images/upload.gif"/>',e.removeAttribute("onclick"))}else{const t=(0,h.curBox)();t&&t.needHideLastCheck?window.boxQueue.hideLast(t.preventHideLastWithCheck):window.boxQueue.hideLast(),this.uploadProgress(e),window.cur.onMediaUploadStarted&&window.cur.onMediaUploadStarted(e.files)}window.cur.setChooseUploadFlag&&window.cur.setChooseUploadFlag("start")}uploadComplete(e){e.cancelled?this.removeProgress(e):"error_code"in e.response&&e.response.error_code?this.choosePhotoUploadFailed(e):((0,c.statlogsValueEvent)("upload_photo_fails",e.response.files.length,e.response.server,"success"),this.isWiki?this.alWysiwygChoosePhotoUploaded(e):this.choosePhotoUploaded(e))}onUploadCompleted(){window.cur.setChooseUploadFlag&&this.isUploadCompletedAll&&window.cur.setChooseUploadFlag("finish")}uploadCompleteAll(){this.isUploadCompletedAll=!0,window.cur.choosePhotoUploadedAll&&window.cur.choosePhotoUploadedAll()}onDragEnter(){const e=document.getElementById("photos_choose_upload_area_wrap");if(!e)return;if(e.classList.contains("photos_choose_upload_area_enter"))return;(0,s.hide)("photos_choose_wrap"),(0,s.hide)("photos_choose_more");const t=document.querySelector("#photos_choose_wrap"),o=(0,s.getXY)(t)[1],r=(0,s.getSize)(e)[1];e.style.height=`${(0,i.scrollGetY)()+document.documentElement.clientHeight-o+r}px`,e.classList.add("photos_choose_upload_area_enter"),this.dropArea.style.overflow="hidden"}onDragLeave(){const e=document.querySelector("#photos_choose_upload_area_wrap");e&&(e.classList.remove("photos_choose_upload_area_enter"),e.style.height="",(0,s.show)("photos_choose_wrap"),(0,s.show)("photos_choose_more"),this.dropArea.style.overflow="")}init(){this.dropArea=document.getElementById("box_layer_wrap"),this.instance=l.GoUploaderHelper.init(this.id,{uploadUrl:this.uploadUrl,input:document.getElementById(`photos_upload_input_${this.albumId}`),multiple:!0,multipleMaxSize:1,dropArea:this.dropArea,uploadMode:d.UploadMode.queue,onDragEnter:this.onDragEnter.bind(this),onDragLeave:this.onDragLeave.bind(this),onBeforeUpload:this.beforeUpload.bind(this),onLoadStart:this.uploadStart.bind(this),onProgress:this.uploadProgress.bind(this),onLoadEnd:this.uploadComplete.bind(this),onLoadEndAll:this.uploadCompleteAll.bind(this),onError:this.choosePhotoUploadFailed.bind(this)}),window.cur.initChooseUploadFlags={},window.cur.setChooseUploadFlag=e=>{var t;window.cur.initChooseUploadFlags&&(e&&(window.cur.initChooseUploadFlags[e]=!0),"start"===e&&delete window.cur.initChooseUploadFlags.finish,window.cur.initChooseUploadFlags.clean_box&&!(null===(t=window.cur)||void 0===t?void 0:t.initChooseUploadFlags.start)&&this.instance.destroy())},window.cur.nav.push((()=>(this.instance.cancelAllUploads(),this.instance.destroy(),!0)))}}},530367:(e,t,o)=>{"use strict";o.d(t,{PhotoSuggestedTagCard:()=>a});var s=o(303770),i=o(70162),r=o(844142);class a extends s.PhotoTagCard{constructor(e){super(e)}confirm(){return this.tagArea.confirmSuggestedTags(this.getTags(),this,this.confirmBtn)}decline(){return this.tagArea.declineSuggestedTags(this.getTags(),this,this.declineBtn)}getResultText(e){const t=this.getOwnerId(),o=this.tagArea.getTags()[0].getOwnerNameGenitive();let a="";switch(e){case s.TagCardViewStatus.CONFIRMED:a=r.Ranges.isUserIdTransitional(t)?i.getLang("photo_recognition_confirm_myself_on_photo"):i.getLang("photo_recognition_confirm_myself_on_photo_group"),a=a.replace("{name}",o);break;case s.TagCardViewStatus.DECLINED:a=r.Ranges.isUserIdTransitional(t)?i.getLang("photo_recognition_decline_on_photo"):i.getLang("photo_recognition_decline_on_photo_group"),a=a.replace("{name}",o);break;default:a=i.getLang("photo_recognition_deleted_tag")}return a}}},310568:(e,t,o)=>{"use strict";var s;o.d(t,{PhotoTag:()=>i}),function(e){e[e.Initial=0]="Initial",e[e.Confirmed=1]="Confirmed",e[e.Declined=2]="Declined"}(s||(s={}));class i{constructor(e,t){this.tagEl=e,this.tagArea=t;const o=e.getAttribute("data-item");if(!o)throw new Error("Tag: incorrect json data");const i=JSON.parse(o);this.id=Number(i.id),this.userId=i.userId,this.name=i.name,this.nameGenitive=i.nameGenitive,this.ownerNameGenitive=i.ownerNameGenitive,this.placerNameGenitive=i.placerNameGenitive,this.nameAccusative=i.nameAccusative,this.isSuggested=Boolean(i.isSuggested),this.sex=Number(i.sex),this.styles={top:i.top,left:i.left,width:i.width,height:i.height};let r=s.Initial;e.classList.contains("PhotoTag--confirm")?r=s.Confirmed:e.classList.contains("PhotoTag--decline")&&(r=s.Declined),this.state=r;const a=`tag_cutout${t.getPhotoRawId()}_${i.userId}`,n=document.getElementById(a);if(!n)throw new Error("Tag: incorrect data");this.cutoutEl=n}decline(){this.tagEl.classList.remove("PhotoTag--confirm"),this.tagEl.classList.add("PhotoTag--decline"),this.cutoutEl.classList.remove("PhotoTagCutout--transparency"),this.state=s.Declined}confirm(){this.tagEl.classList.remove("PhotoTag--decline"),this.tagEl.classList.add("PhotoTag--confirm"),this.cutoutEl.classList.add("PhotoTagCutout--transparency"),this.state=s.Confirmed}reset(){this.tagEl.classList.remove("PhotoTag--decline"),this.tagEl.classList.remove("PhotoTag--confirm"),this.cutoutEl.classList.remove("PhotoTagCutout--transparency"),this.state=s.Initial}getFullRawId(){return`${this.tagArea.getPhotoRawId()}_${this.getId()}`}getId(){return this.id}getUserId(){return this.userId}getUserName(){return this.name}getUserNameGenitive(){return this.nameGenitive}getUserNameAccusative(){return this.nameAccusative}getOwnerNameGenitive(){return this.ownerNameGenitive}getPlacerNameGenitive(){return this.placerNameGenitive}isConfirmed(){return this.state===s.Confirmed}getSex(){return this.sex}}},959115:(e,t,o)=>{"use strict";o.d(t,{PhotoTagArea:()=>h});var s=o(310568),i=o(897449),r=o(506770),a=o(501389),n=o(70162),l=o(146143),d=o(365931);class h{constructor(e,t,o){this.confirmTag=(e,t,o)=>{o&&(0,i.lockButton)(o);const s=!(0,r.partConfigEnabled)("recognize_mock_turn_off");return new Promise(((r,l)=>{window.ajax.post("al_photos.php",{act:"confirm_tag",photo:t.getPhotoRawId(),tag:e.getId(),hash:this.tagHash},{onDone:()=>{this.setConfirmedTags([e]),this.decrementLeftMenuCounterIfNeeded([e]),r()},onFail:()=>s?(this.setConfirmedTags([e]),r(),!0):((0,a.showDoneBox)(n.getLang("global_unknown_error")),l(),!0),hideProgress:()=>{o&&(0,i.unlockButton)(o)}})}))},this.declineTag=(e,t,o)=>new Promise(((s,l)=>{o&&(0,i.lockButton)(o);const d=!(0,r.partConfigEnabled)("recognize_mock_turn_off");window.ajax.post("al_photos.php",{act:"delete_tag",photo:t.getPhotoRawId(),tag:e.getId(),hash:this.tagHash},{onDone:()=>{this.setDeclinedTags([e]),this.decrementLeftMenuCounterIfNeeded([e]),s()},onFail:()=>d?(this.setDeclinedTags([e]),s(),!0):((0,a.showDoneBox)(n.getLang("global_unknown_error")),l(),!0),hideProgress:()=>{o&&(0,i.unlockButton)(o)}})})),this.confirmSuggestedTags=(e,t,o)=>this.showConfirmAlertBoxIfNeeded(e).then((()=>{o&&(0,i.lockButton)(o);const t=!(0,r.partConfigEnabled)("recognize_mock_turn_off");return new Promise(((s,r)=>{window.ajax.post("al_photos.php",{act:"confirm_suggested_tags",tag_raw_ids:this.getFullRawTagIdsStr(e),track_code:this.trackCode,hash:this.tagHash},{onDone:()=>{this.setConfirmedTags(e),this.decrementLeftMenuCounterIfNeeded(e),s()},onFail:()=>t?(this.setConfirmedTags(e),s(),!0):((0,a.showDoneBox)(n.getLang("global_unknown_error")),r(),!0),hideProgress:()=>{o&&(0,i.unlockButton)(o)}})}))})),this.declineSuggestedTags=(e,t,o)=>new Promise(((t,s)=>{o&&(0,i.lockButton)(o);const l=!(0,r.partConfigEnabled)("recognize_mock_turn_off");window.ajax.post("al_photos.php",{act:"decline_suggested_tags",tag_raw_ids:this.getFullRawTagIdsStr(e),track_code:this.trackCode,hash:this.tagHash},{onDone:()=>{this.setDeclinedTags(e),this.decrementLeftMenuCounterIfNeeded(e),t()},onFail:()=>l?(this.setDeclinedTags(e),t(),!0):((0,a.showDoneBox)(n.getLang("global_unknown_error")),s(),!0),hideProgress:()=>{o&&(0,i.unlockButton)(o)}})}));const l=e.getEl().querySelector(".PhotoTagArea");if(!l)throw new Error("error: there is not tag area el");if(!t)throw new Error("error: there is not tag hash");const d=Array.from(e.getEl().querySelectorAll(".PhotoTag"));this.trackCode=o,this.tagArea=l,this.tagHash=t,this.photoEntity=e,this.tags=d.map((e=>new s.PhotoTag(e,this))),this.tagsMap=this.tags.reduce(((e,t)=>(e[t.getId()]=t,e)),{})}showConfirmAlertBoxIfNeeded(e){const t=e[0];return new Promise(((e,o)=>{if(!window.cur.pvNeedShowAlertForOneSuggest||t.getUserId()===window.vk.id)return void e();const s=n.getLang("photo_recognition_one_tag_alert"),i=(0,n.langSex)(t.getSex(),n.getLang("photo_recognition_one_tag_alert_text","raw")).replace("{name}",t.getUserName()),r=(0,l.showFastBox)(s,i,n.getLang("photo_recognition_one_friend_submit_btn"),(()=>{this.hideHint(),r.hide(),e()}),n.getLang("global_cancel"),(()=>{r.hide(),o()}))}))}hideHint(){window.cur.pvNeedShowAlertForOneSuggest=!1;const e=window.cur.pvOneSuggestHintId,t=window.cur.pvOneSuggestHintHash;e&&t&&window.ajax.post("al_index.php",{act:"help_hints_hide",hint_id:e,hash:t},{onDone:()=>{},onFail:()=>(console.error("something wrong with help hint"),!0)})}decrementLeftMenuCounterIfNeeded(e){e.forEach((e=>{e.getUserId()===window.vk.id&&(0,d.decrementLeftMenuPhotoCounter)()}))}getFullRawTagIdsStr(e=this.tags){return e.reduce(((e,t,o)=>e+`${0===o?"":","}${t.getFullRawId()}`),"")}setConfirmedTagsByIds(e){const t=e.reduce(((e,t)=>(this.tagsMap[t]&&e.push(this.tagsMap[t]),e)),[]);return!!t.length&&(this.setConfirmedTags(t),!0)}setConfirmedTags(e){(e=e.filter((e=>this.tagsMap[e.getId()]))).length&&(e.forEach((e=>e.confirm())),this.tagArea.classList.add("PhotoTagArea--fade"))}setDeclinedTags(e){e.forEach((e=>e.decline()))}setDeclinedTagsByIds(e){const t=e.reduce(((e,t)=>(this.tagsMap[t]&&e.push(this.tagsMap[t]),e)),[]);return!!t.length&&(this.setDeclinedTags(t),!0)}reset(){this.tagArea.classList.remove("PhotoTagArea--fade"),this.tags.forEach((e=>e.reset()))}getPhotoRawId(){return this.photoEntity.getPhotoRawId()}getTags(){return this.tags}getConfirmedTags(){return this.tags.filter((e=>e.isConfirmed()))}setSizes(e,t){this.tagArea.style.width=`${e}px`,this.tagArea.style.height=`${t}px`}show(){this.tagArea.classList.remove("PhotoTagArea--hide")}static calculateTagAreaSizes(e,t,o){const s=e.offsetWidth,i=e.offsetHeight,r=t/o;let a,n,l=!0;return s/i>r&&(l=!1),l?(a=Math.round(Math.min(t,s)),n=Math.round(a/r)):(n=Math.round(Math.min(o,i)),a=Math.round(n*r)),[a,n]}}},990523:(e,t,o)=>{"use strict";o.d(t,{PHOTO_TAG_BLOCK_CLASS:()=>_,PhotoTagBlock:()=>m});var s=o(303770),i=o(123251),r=o(550261),a=o(530367),n=o(368752),l=o(897449),d=o(873589),h=o(146143),c=o(70162),u=o(365931),p=o(501389),g=o(124041);const _="PhotoTagBlock";class m{constructor(e,t){this.isLoading=!1,this.isDestroyed=!1,this.handleOutsideConfirmationSuggestedTags=e=>{const t=e.detail.photoRawId,o=e.detail.tagIds;this.cards.filter((e=>e.getPhotoRawId()===t)).forEach((e=>e.setConfirmedTagsByIds(o)))},this.handleOutsideDeclinationSuggestedTags=e=>{const t=e.detail.photoRawId,o=e.detail.tagIds;this.cards.filter((e=>e.getPhotoRawId()===t)).forEach((e=>e.setDeclinedTagsByIds(o)))},this.handleOutsideConfirmationUserTag=e=>{const t=e.detail.photoRawId,o=e.detail.tagId,s=this.cards.find((e=>e.getPhotoRawId()===t));s&&s.setConfirmedTagsByIds([o])},this.handleOutsideDeclinationUserTag=e=>{const t=e.detail.photoRawId,o=e.detail.tagId,s=this.cards.find((e=>e.getPhotoRawId()===t));s&&s.setDeclinedTagsByIds([o])},this.handleOutsideDeletingTags=e=>{const t=e.detail.photoRawId,o=e.detail.tagIds;this.cards.filter((e=>e.getPhotoRawId()===t)).forEach((e=>e.setDeletedTagsByIds(o)))},this.checkScroll=(0,n.debounce)((()=>{this.isLoading||window.innerHeight+window.pageYOffset+700>=this.cardsBlock.getBoundingClientRect().bottom&&this.loadMore()}),200),this.loadMore=()=>{!this.isLoading&&this.nextOffset&&(this.isLoading=!0,window.ajax.post("al_photos.php",{act:"recognition_tags",part:1,offset:this.nextOffset,is_full_page:Number(this.isFullPage)},{onDone:(e,t,o)=>{if(this.isLoading=!1,this.isDestroyed)return;this.fullCardsNumber=t,this.nextOffset=o,this.nextOffset||document.removeEventListener("scroll",this.checkScroll);const s=null==e?void 0:e.map((e=>{const t=(0,d.se)(e);return this.cardsBlock.appendChild(t),t}));(null==s?void 0:s.length)&&this.cards.push(...this.createCards(s)),o||(0,d.hide)(this.loadMoreBtn)},showProgress:()=>(0,l.lockButton)(this.loadMoreBtn),hideProgress:()=>(0,l.unlockButton)(this.loadMoreBtn)}))},this.getAllTagElements=e=>Array.from(e.querySelectorAll(`.${s.PHOTO_TAG_CARD_CLASS}`)),this.onConfirmAll=()=>{if(!this.confirmAllHash)return;const e=this.getActiveCardsNumber();window.ajax.post("al_photos.php",{act:"confirm_all_tags",hash:this.confirmAllHash},{onDone:()=>{this.onSubmitAll(e,c.getLang("photo_tags_confirmed_text",e))},onFail:e=>((0,h.showFastBox)(c.getLang("global_error"),e||c.getLang("global_unknown_error")),!0),showProgress:()=>this.confirmAllBtn&&g.FlatButton.lock(this.confirmAllBtn),hideProgress:()=>this.confirmAllBtn&&g.FlatButton.unlock(this.confirmAllBtn)})},this.onDeclineAll=()=>{if(!this.declineAllHash)return;const e=this.getActiveCardsNumber(),t=t=>{window.ajax.post("al_photos.php",{act:"decline_all_tags",hash:this.declineAllHash},{onDone:()=>{this.onSubmitAll(e,c.getLang("photo_tags_declined_text",e))},onFail:e=>((0,h.showFastBox)(c.getLang("global_error"),e||c.getLang("global_unknown_error")),!0),showProgress:()=>(0,l.lockButton)(t),hideProgress:()=>(0,l.unlockButton)(t)})};(0,h.showFastBox)(c.getLang("photo_tag_decline_box_title",e),c.getLang("photo_tag_decline_box_description"),c.getLang("photo_recognition_decline_all"),(e=>{t(e)}),c.getLang("global_cancel"))},this.block=e,this.isFullPage=t.isFullPage,this.fullCardsNumber=t.fullCardsNumber,this.nextOffset=t.nextOffset,this.confirmAllHash=t.confirmAllHash,this.declineAllHash=t.declineAllHash,this.submitAllLimit=t.submitAllLimit;const o=this.block.querySelector(".PhotoTagBlock__cards");if(!o)throw new Error("PhotoTagBlock: incorrect data");this.cardsBlock=o,this.loadMoreBtn=this.block.querySelector(".PhotoTagBlock__loadMoreBtn"),this.confirmAllBtn=document.querySelector(".PhotoTagBlock__confirmAll"),this.declineAllBtn=document.querySelector(".PhotoTagBlock__declineAll"),this.cards=this.createCards(this.getAllTagElements(this.cardsBlock)),this.initListeners()}initListeners(){var e,t,o;null===(e=this.confirmAllBtn)||void 0===e||e.addEventListener("click",this.onConfirmAll),null===(t=this.declineAllBtn)||void 0===t||t.addEventListener("click",this.onDeclineAll),null===(o=this.loadMoreBtn)||void 0===o||o.addEventListener("click",this.loadMore),document.addEventListener(i.TagEventTypes.CONFIRM_SUGGESTED_TAGS,this.handleOutsideConfirmationSuggestedTags),document.addEventListener(i.TagEventTypes.DECLINE_SUGGESTED_TAGS,this.handleOutsideDeclinationSuggestedTags),document.addEventListener(i.TagEventTypes.CONFIRM_USER_TAG,this.handleOutsideConfirmationUserTag),document.addEventListener(i.TagEventTypes.DECLINE_USER_TAG,this.handleOutsideDeclinationUserTag),document.addEventListener(i.TagEventTypes.DELETE_TAG,this.handleOutsideDeletingTags),this.nextOffset&&this.isFullPage&&window.addEventListener("scroll",this.checkScroll)}deInitListeners(){var e,t,o;null===(e=this.confirmAllBtn)||void 0===e||e.removeEventListener("click",this.onConfirmAll),null===(t=this.declineAllBtn)||void 0===t||t.removeEventListener("click",this.onDeclineAll),null===(o=this.loadMoreBtn)||void 0===o||o.removeEventListener("click",this.loadMore),document.removeEventListener(i.TagEventTypes.CONFIRM_SUGGESTED_TAGS,this.handleOutsideConfirmationSuggestedTags),document.removeEventListener(i.TagEventTypes.DECLINE_SUGGESTED_TAGS,this.handleOutsideDeclinationSuggestedTags),document.removeEventListener(i.TagEventTypes.CONFIRM_USER_TAG,this.handleOutsideConfirmationUserTag),document.removeEventListener(i.TagEventTypes.DECLINE_USER_TAG,this.handleOutsideDeclinationUserTag),document.removeEventListener(i.TagEventTypes.DELETE_TAG,this.handleOutsideDeletingTags),this.isFullPage&&this.nextOffset&&document.removeEventListener("scroll",this.checkScroll)}onSubmitAll(e,t){const o=(0,p.curBox)();o&&o.hide(),(0,u.decrementLeftMenuPhotoCounter)(e);let s="";s=!this.submitAllLimit||this.fullCardsNumber<=this.submitAllLimit?`/albums${window.vk.id}`:`/albums${window.vk.id}?act=recognition_tags`,this.go(s,t)}go(e,t=""){const o=document.querySelector("#box_layer_wrap"),s=document.querySelector("#box_loader");window.nav.go(e,null,{onDone:()=>{t&&(0,p.showDoneBox)(t)},showProgress:()=>{(0,d.show)(o),(0,d.show)(s),(0,p.boxRefreshCoords)(s)},hideProgress:()=>{(0,d.hide)(o),(0,d.hide)(s)}})}getActiveCardsNumber(){const e=this.cards.filter((e=>e.isActive())).length,t=this.cards.length-e;return this.fullCardsNumber-t}destroy(){this.isDestroyed=!0,this.deInitListeners(),this.cards.forEach((e=>e.destroy()))}createCards(e){return e.map((e=>s.PhotoTagCard.isPhotoSuggestedTagCard(e)?new a.PhotoSuggestedTagCard(e):new r.PhotoUserTagCard(e)))}}},303770:(e,t,o)=>{"use strict";o.d(t,{PHOTO_TAG_CARD_CLASS:()=>h,TagCardViewStatus:()=>u,PhotoTagCard:()=>p});var s=o(520820),i=o(959115),r=o(274642),a=o(873589),n=o(152278),l=o(66433),d=o(996885);const h="PhotoTagCard",c="PhotoTagCard--noSize";var u;!function(e){e[e.ACTIVE=0]="ACTIVE",e[e.CONFIRMED=1]="CONFIRMED",e[e.DECLINED=2]="DECLINED",e[e.DELETED=3]="DELETED"}(u||(u={}));class p{constructor(e){this.status=u.ACTIVE,this.isLoading=!1,this.onPhotoClick=e=>{e.ctrlKey||e.metaKey||(this.showPhoto(e),(0,n.cancelEvent)(e))},this.onConfirmClick=()=>{this.confirm().then((()=>{const e=this.getTags();this.tagArea.setConfirmedTags(e),this.updatePhotoviewCache(!0),this.setViewStatus(u.CONFIRMED)}),(e=>{e&&(0,l.logError)(e)})).finally((()=>{this.isLoading=!1}))},this.onDeclineClick=()=>{this.isLoading||(this.isLoading=!0,this.decline().then((()=>{this.setOverlay(),this.updatePhotoviewCache(!0),this.setViewStatus(u.DECLINED)}),(e=>{e&&(0,l.logError)(e)})).finally((()=>{this.isLoading=!1})))},this.onCancelClick=()=>{this.setOverlay(!1),this.tagArea.reset(),this.setViewStatus(u.ACTIVE)},this.el=e;const t=e.dataset.photoViewOptions,o=e.dataset.photoContext,r=e.dataset.photoRawId,a=t&&(0,s.parseJSON)(t),d=e.dataset.tagHash;if(!(a&&r&&o&&d))throw new Error("PhotoTagCard: incorrect arguments");const[h,c]=r.split("_");this.ownerId=Number(h),this.photoId=Number(c),this.photoRawId=r,this.photoContext=o,this.photoViewOptions=a,this.photoUrl=e.dataset.photoUrl;const p=e.querySelector(".PhotoTagCard__button--confirm"),g=e.querySelector(".PhotoTagCard__button--decline"),_=e.querySelector(".PhotoTagCard__button--cancelConfirm"),m=e.querySelector(".PhotoTagCard__button--cancelDecline"),f=e.querySelector(".PhotoTagCard__desc"),v=e.querySelector(".PhotoTagCard__photo"),w=e.querySelector(".PhotoTagCard__result");if(!(p&&g&&f&&v&&w))throw new Error("PhotoTagCard: there are not elements");this.photoEl=v,this.confirmBtn=p,this.declineBtn=g,this.description=f,this.cancelConfirmBtn=_,this.cancelDeclineBtn=m,this.resultPanel=w,this.tagArea=new i.PhotoTagArea(this,d),this.init()}destroy(){this.deInitListeners()}getPhotoRawId(){return this.photoRawId}getEl(){return this.photoEl}setConfirmedTagsByIds(e){this.tagArea.setConfirmedTagsByIds(e)&&this.setViewStatus(u.CONFIRMED)}setDeclinedTagsByIds(e){this.tagArea.setDeclinedTagsByIds(e)&&(this.setOverlay(),this.setViewStatus(u.DECLINED))}setDeletedTagsByIds(e){this.tagArea.setDeclinedTagsByIds(e)&&this.setViewStatus(u.DELETED)}static isPhotoSuggestedTagCard(e){return Boolean(Number(e.dataset.isSuggest))}init(){this.initListeners(),this.photoUrl&&this.checkPhotoHasNoSizes()&&this.correctTagView(this.photoUrl)}initListeners(){var e,t;this.confirmBtn.addEventListener("click",this.onConfirmClick),this.declineBtn.addEventListener("click",this.onDeclineClick),null===(e=this.cancelConfirmBtn)||void 0===e||e.addEventListener("click",this.onCancelClick),null===(t=this.cancelDeclineBtn)||void 0===t||t.addEventListener("click",this.onCancelClick),this.photoEl.addEventListener("click",this.onPhotoClick)}deInitListeners(){var e,t;this.confirmBtn.removeEventListener("click",this.onConfirmClick),this.declineBtn.removeEventListener("click",this.onDeclineClick),null===(e=this.cancelConfirmBtn)||void 0===e||e.removeEventListener("click",this.onCancelClick),null===(t=this.cancelDeclineBtn)||void 0===t||t.removeEventListener("click",this.onCancelClick),this.photoEl.removeEventListener("click",this.onPhotoClick)}setViewStatus(e){const t=this.resultPanel.querySelector(".PhotoTagCard__resultWrapper");if(t){if(this.status=e,e===u.ACTIVE)return(0,a.hide)(this.resultPanel),void(0,a.show)(this.description);t.innerHTML=this.getResultText(e),(0,a.hide)(this.description),e===u.CONFIRMED?(this.resultPanel.classList.add("PhotoTagCard__result--confirm"),this.resultPanel.classList.remove("PhotoTagCard__result--decline")):e===u.DECLINED?(this.resultPanel.classList.remove("PhotoTagCard__result--confirm"),this.resultPanel.classList.add("PhotoTagCard__result--decline")):(this.resultPanel.classList.remove("PhotoTagCard__result--confirm"),this.resultPanel.classList.remove("PhotoTagCard__result--decline")),(0,a.show)(this.resultPanel)}}setOverlay(e=!1){this.photoEl.classList.toggle("PhotoTagCard__photo--disable",e)}showPhoto(e){(0,r.showPhoto)(this.photoRawId,this.photoContext,this.photoViewOptions,e),this.updatePhotoviewCache()}getTags(){return this.tagArea.getTags()}getConfirmedTags(){return this.tagArea.getConfirmedTags()}updatePhotoviewCache(e=!1){this.photoViewOptions.noCache=e,e&&(0,d.dropPhotoCacheData)()}checkPhotoHasNoSizes(){return this.el.classList.contains(c)}correctTagView(e){const t=new Image;t.onload=()=>{const o=t.width,s=t.height;if(o&&s){const[t,r]=i.PhotoTagArea.calculateTagAreaSizes(this.photoEl,o,s),a=this.el.querySelector(".PhotoTagCard__stub");a&&a.remove();const n=document.createElement("div");n.classList.add("PhotoTagCard__image"),n.style.backgroundSize=`${t}px ${r}px`,n.style.backgroundImage=`url('${e}')`,this.photoEl.appendChild(n);const l=t+1,d=r+1;this.tagArea.setSizes(l,d),this.tagArea.show(),this.el.classList.remove(c)}},t.src=e}getOwnerId(){return this.ownerId}isActive(){return this.status===u.ACTIVE}}},550261:(e,t,o)=>{"use strict";o.d(t,{PhotoUserTagCard:()=>r});var s=o(303770),i=o(70162);class r extends s.PhotoTagCard{constructor(e){super(e)}confirm(){const e=this.getTags();return this.tagArea.confirmTag(e[0],this,this.confirmBtn)}decline(){const e=this.getTags();return this.tagArea.declineTag(e[0],this,this.declineBtn)}getResultText(e){const t=this.getTags()[0].getPlacerNameGenitive()||"";let o="";switch(e){case s.TagCardViewStatus.CONFIRMED:o=i.getLang("photo_recognition_confirm_myself").replace("{name}",t);break;case s.TagCardViewStatus.DECLINED:o=i.getLang("photo_recognition_decline_myself").replace("{name}",t);break;default:o=i.getLang("photo_recognition_deleted_tag")}return o}}},365931:(e,t,o)=>{"use strict";o.d(t,{decrementLeftMenuPhotoCounter:()=>n});var s=o(342269),i=o(66433),r=o(101178);const a="ph";function n(e=1){try{const t=function(){const e=document.getElementById("l_ph");if(!e)throw new Error("There is not photo left menu item");const t=e.querySelector(".left_count");return t?(0,s.intval)(t.textContent):0}();(0,r.handlePageCount)(a,Math.max(t-e,0))}catch(e){console.error(e),(0,i.logError)(e)}}},123251:(e,t,o)=>{"use strict";var s;o.d(t,{TagEventTypes:()=>s}),function(e){e.CONFIRM_SUGGESTED_TAGS="CONFIRM_SUGGESTED_TAGS",e.DECLINE_SUGGESTED_TAGS="DECLINE_SUGGESTED_TAGS",e.DECLINE_USER_TAG="DECLINE_USER_TAG",e.CONFIRM_USER_TAG="CONFIRM_USER_TAG",e.DELETE_TAG="DELETE_TAG"}(s||(s={}))}}]);try{stManager.done("dist/ed02da901f6e6d717716f8686f741618.0705b2f03e6581c368e8.js")}catch(e){}